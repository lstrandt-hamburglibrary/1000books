<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1000 Books Before Kindergarten - Hamburg Township Library</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="1000 Books">
    <link rel="apple-touch-icon" href="icon-192.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .app-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .app-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Install prompt styles */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 10000;
            max-width: 90%;
            width: 350px;
        }

        .install-prompt.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .install-prompt-content {
            text-align: center;
        }

        .install-prompt h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.2rem;
        }

        .install-prompt p {
            margin: 0 0 15px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .install-prompt-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .install-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .install-btn-primary {
            background: #667eea;
            color: white;
        }

        .install-btn-primary:hover {
            background: #5a67d8;
        }

        .install-btn-secondary {
            background: #e9ecef;
            color: #333;
        }

        .install-btn-secondary:hover {
            background: #dee2e6;
        }

        .child-selector {
            margin-top: 10px;
        }

        .child-selector select {
            padding: 8px 15px;
            border-radius: 25px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1rem;
            cursor: pointer;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            padding: 10px;
            gap: 10px;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .content {
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Dashboard Styles */
        .progress-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .progress-circle {
            width: 250px;
            height: 250px;
            margin: 0 auto;
        }

        .progress-text {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
        }

        .progress-label {
            font-size: 1.2rem;
            color: #6c757d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-emoji {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #495057;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .rating-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .rating-btn {
            padding: 10px 20px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .rating-btn:hover {
            background: #f8f9fa;
        }

        .rating-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .submit-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        /* Library Styles */
        .library-grid {
            display: block;
            width: 100%;
            margin-top: 20px;
        }

        .book-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .book-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .book-author {
            color: #6c757d;
            margin-bottom: 5px;
        }

        .book-date {
            font-size: 0.9rem;
            color: #adb5bd;
        }

        .book-rating {
            margin-top: 10px;
        }

        /* Badges */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .badge-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .badge-card.earned {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .badge-card.locked {
            opacity: 0.5;
        }

        .badge-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .badge-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .badge-description {
            font-size: 0.9rem;
        }

        /* Recent Books */
        .recent-books {
            margin-top: 30px;
        }

        .recent-books h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .recent-books-list {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .recent-book {
            min-width: 150px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        /* Speed button highlighting */
        .speed-btn {
            background: #667eea;
            color: white;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .speed-btn.speed-selected {
            background: #28a745 !important;
            color: white !important;
            border: 2px solid #1e7e34 !important;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .speed-btn:hover:not(.speed-selected) {
            background: #5a5fcc;
            transform: scale(1.05);
        }

        /* Enhanced Animations */
        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% center;
            }
            100% {
                background-position: 200% center;
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(102, 126, 234, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
            }
        }

        /* Update Banner */
        .update-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: center;
            display: none;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .update-banner.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .update-banner button {
            margin-left: 10px;
            padding: 5px 15px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .update-banner .update-now {
            background: white;
            color: #667eea;
        }

        .update-banner .update-later {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }

        /* Milestones */
        .milestone-tracker {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .milestone-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .milestone-progress {
            font-size: 1.2rem;
        }

        .next-milestone {
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Games Styles */
        .games-intro {
            text-align: center;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .game-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .game-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .game-card.unlocked {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .game-card.unlocked:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .game-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .game-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .game-requirement {
            font-size: 0.9rem;
        }

        /* Mini Game Styles */
        .mini-game {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            max-width: 480px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .game-header h3 {
            margin: 0;
            color: #495057;
        }

        .game-close-btn {
            background: #dc3545;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            position: relative;
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-close-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .game-instructions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .game-score {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #495057;
        }

        .game-level-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .level-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .level-btn:hover {
            background: #f8f9fa;
        }

        .level-btn.active {
            background: #667eea;
            color: white;
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* Dog Park Dash Styles */
        .park-game-area {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D982 100%);
        }

        .park-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                #98D982 0px,
                #98D982 40px,
                #8BC97F 40px,
                #8BC97F 80px
            );
            opacity: 0.3;
        }

        .dog-character {
            position: absolute;
            font-size: 3rem;
            transition: all 0.2s ease;
            z-index: 10;
            animation: dogBob 0.5s infinite;
        }

        @keyframes dogBob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .dog-character.running {
            animation: dogRun 0.3s infinite;
        }

        @keyframes dogRun {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .game-item {
            position: absolute;
            font-size: 2rem;
            transition: all 0.3s;
            cursor: pointer;
            animation: itemFloat 2s infinite;
        }

        .game-item[data-type="obstacle"] {
            animation: obstacleJump 1s infinite;
            filter: drop-shadow(0 0 3px rgba(255, 0, 0, 0.5));
        }

        @keyframes obstacleJump {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(10deg); }
        }

        @keyframes itemFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .game-item.collected {
            animation: collectItem 0.5s;
            opacity: 0;
        }

        @keyframes collectItem {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.5) rotate(180deg); }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }

        .score-popup {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
            animation: scoreFloat 1s;
            pointer-events: none;
            z-index: 20;
        }

        @keyframes scoreFloat {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* Snowflake Catcher Styles */
        .snow-game-area {
            position: relative;
            height: 400px;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%);
            border-radius: 10px;
            overflow: hidden;
            cursor: none;
        }

        .snow-catcher {
            position: absolute;
            font-size: 2.5rem;
            z-index: 10;
            pointer-events: none;
            transition: transform 0.1s ease;
        }

        .falling-snowflake {
            position: absolute;
            font-size: 1.5rem;
            animation: snowfall linear;
            cursor: pointer;
            z-index: 5;
        }

        .falling-snowflake.special {
            font-size: 2rem;
            filter: drop-shadow(0 0 10px rgba(135, 206, 235, 0.8));
        }

        @keyframes snowfall {
            from {
                transform: translateY(-50px) rotate(0deg);
            }
            to {
                transform: translateY(450px) rotate(360deg);
            }
        }

        @keyframes snowCatch {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        @keyframes snowmanComplete {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.3) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(360deg);
                opacity: 1;
            }
        }

        .dog-fact-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .dog-fact-display h4 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .dog-fact-display p {
            margin: 0;
            font-size: 0.95rem;
        }

        .game-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .game-btn {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .hint-btn {
            background: #ffc107;
            color: white;
        }

        .hint-btn:hover:not(:disabled) {
            background: #ffb300;
            transform: translateY(-2px);
        }

        .hint-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .reset-btn {
            background: #667eea;
            color: white;
        }

        .reset-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .high-score {
            text-align: center;
            font-size: 1.1rem;
            color: #495057;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .timer-warning {
            animation: timerPulse 1s infinite;
            color: #dc3545 !important;
            font-weight: bold;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        /* Dragon Maze Styles */
        .maze-game-area {
            position: relative;
            height: 320px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }

        #mazeCanvas {
            background: white;
            border: 2px solid #333;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .maze-arrow-btn {
            display: inline-block;
            padding: 15px 20px;
            margin: 5px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .maze-arrow-btn:hover {
            transform: scale(1.05);
            background: #764ba2;
        }

        .maze-arrow-btn:active {
            transform: scale(0.95);
        }

        .game-controls:has(.maze-arrow-btn) {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            max-width: 200px;
            margin: 10px auto;
        }

        /* Suggestions Styles */
        .suggestion-lists {
            margin-top: 20px;
        }

        .suggestion-category {
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .suggestion-category-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transition: all 0.3s;
        }

        .suggestion-category-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        .suggestion-category-header h3 {
            color: #495057;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expand-icon {
            font-size: 1.2rem;
            transition: transform 0.3s;
            color: #6c757d;
        }

        .suggestion-category.collapsed .expand-icon {
            transform: rotate(-90deg);
        }

        .suggestion-category-content {
            padding: 0 20px 20px 20px;
            max-height: none;
            opacity: 1;
            transition: opacity 0.3s ease, padding 0.3s ease;
        }

        .suggestion-category.collapsed .suggestion-category-content {
            display: none;
            opacity: 0;
            padding: 0 20px;
        }

        .suggestion-books {
            display: grid;
            gap: 10px;
        }

        .suggestion-book {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .suggestion-book:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .suggestion-book-info {
            flex: 1;
        }

        .suggestion-book-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .suggestion-book-author {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .suggestion-book-age {
            color: #adb5bd;
            font-size: 0.85rem;
            margin-top: 3px;
        }

        .add-suggestion-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .add-suggestion-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .add-suggestion-btn.added {
            background: #28a745;
            cursor: default;
        }

        /* Enhanced Mobile & Touch Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .app-container {
                border-radius: 10px;
            }
            .app-header {
                padding: 15px;
            }
            .app-header h1 {
                font-size: 1.5rem;
            }
            .content {
                padding: 15px;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .nav-tabs::-webkit-scrollbar {
                display: none;
            }
            .nav-tab {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            .quick-add-buttons {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            .quick-add-btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            .books-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .book-card {
                padding: 12px;
            }
            .badge-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            .milestone-card {
                padding: 12px;
            }
            .games-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .game-card {
                padding: 15px;
            }
            /* Touch-friendly buttons */
            button, .btn, .quick-add-btn, .nav-tab {
                -webkit-tap-highlight-color: rgba(102, 126, 234, 0.2);
                touch-action: manipulation;
                user-select: none;
            }
            /* Improve input fields for mobile */
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
            }
            /* Modal adjustments for mobile */
            .modal-content {
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
            }
            /* Dog Park Game mobile adjustments */
            .mini-game {
                width: 95%;
                left: 2.5%;
                right: 2.5%;
                top: 10px;
                transform: none;
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }
            .park-game-area {
                height: 250px;
            }
            .game-controls {
                flex-wrap: wrap;
            }
            .game-btn {
                min-width: 80px;
                padding: 12px;
            }
            /* Touch swipe controls for game */
            .park-game-area {
                touch-action: none;
            }
        }
        /* Extra small devices */
        @media (max-width: 480px) {
            .app-header h1 {
                font-size: 1.2rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .badge-container {
                grid-template-columns: 1fr;
            }
            .nav-tab {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
        }
        /* Improved touch interactions */
        @media (hover: none) and (pointer: coarse) {
            .book-card:active,
            .quick-add-btn:active,
            .nav-tab:active,
            .game-card:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
            /* Larger touch targets */
            .book-actions button {
                padding: 10px 15px;
                margin: 2px;
            }
            /* Better scrolling */
            .books-list,
            .badge-container,
            .milestones-list {
                -webkit-overflow-scrolling: touch;
            }
        }
        /* Landscape mobile adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .app-container {
                max-height: 100vh;
                overflow-y: auto;
            }
            .park-game-area {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Update Banner -->
    <div class="update-banner" id="updateBanner">
        <span>📣 New version available with bug fixes and improvements!</span>
        <button class="update-now" onclick="updateNow()">Update Now</button>
        <button class="update-later" onclick="dismissUpdate()">Later</button>
    </div>

    <div class="app-container">
        <!-- Header -->
        <div class="app-header">
            <h1>📚 1000 Books Before Kindergarten</h1>
            <button id="permanentInstallBtn" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 8px 15px; border-radius: 25px; cursor: pointer; font-size: 0.9rem; display: none;" onclick="triggerInstall()">
                📲 Install App
            </button>
            <div class="child-selector">
                <select id="childSelect" onchange="switchChild(this.value)">
                    <option value="">Select Child</option>
                </select>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('dashboard', this)">📊 Dashboard</button>
            <button class="nav-tab" onclick="showPage('add-book', this)">➕ Add Book</button>
            <button class="nav-tab" onclick="showPage('suggestions', this)">💡 Suggestions</button>
            <button class="nav-tab" onclick="showPage('library', this)">📚 Library</button>
            <button class="nav-tab" onclick="showPage('badges', this)">🏆 Badges</button>
            <button class="nav-tab" onclick="showPage('milestones', this)">🎯 Milestones</button>
            <button class="nav-tab" onclick="showPage('games', this)">🎮 Games</button>
            <button class="nav-tab" onclick="showPage('settings', this)">⚙️ Settings</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="progress-container">
                    <svg class="progress-circle" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="90" fill="none" stroke="#e9ecef" stroke-width="10"/>
                        <circle cx="100" cy="100" r="90" fill="none" stroke="#667eea" stroke-width="10"
                                stroke-dasharray="565" stroke-dashoffset="565" id="progressCircle"
                                transform="rotate(-90 100 100)"/>
                    </svg>
                    <div class="progress-text" id="bookCount">0</div>
                    <div class="progress-label">books read</div>
                </div>

                <div class="milestone-tracker" id="milestoneTracker" style="display: none;">
                    <div class="milestone-title">🎉 Next Milestone</div>
                    <div class="milestone-progress" id="milestoneProgress"></div>
                    <div class="next-milestone" id="nextMilestone"></div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-emoji">📅</div>
                        <div class="stat-value" id="daysActive">0</div>
                        <div class="stat-label">Days Active</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-emoji">📖</div>
                        <div class="stat-value" id="thisWeek">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-emoji">⭐</div>
                        <div class="stat-value" id="favorites">0</div>
                        <div class="stat-label">Favorites</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-emoji">🔥</div>
                        <div class="stat-value" id="streak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>

                <div class="recent-books">
                    <h3>Recently Read</h3>
                    <div class="recent-books-list" id="recentBooks">
                        <p style="color: #6c757d;">No books added yet. Start your reading journey!</p>
                    </div>
                </div>
            </div>

            <!-- Add Book Page -->
            <div id="add-book" class="page">
                <h2>Add a New Book</h2>
                <form id="addBookForm" onsubmit="addBook(event)">
                    <div class="form-group">
                        <label for="bookTitle">Book Title *</label>
                        <input type="text" id="bookTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="bookAuthor">Author</label>
                        <input type="text" id="bookAuthor">
                    </div>
                    <div class="form-group">
                        <label for="readDate">Date Read *</label>
                        <input type="date" id="readDate" required>
                    </div>
                    <div class="form-group">
                        <label for="bookCategory">Category (optional)</label>
                        <select id="bookCategory">
                            <option value="">Select a category...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>How did you like it?</label>
                        <div class="rating-buttons">
                            <button type="button" class="rating-btn" onclick="selectRating(this, 'love')">😍 Loved it!</button>
                            <button type="button" class="rating-btn" onclick="selectRating(this, 'like')">😊 Liked it</button>
                            <button type="button" class="rating-btn" onclick="selectRating(this, 'okay')">😐 It was okay</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes (optional)</label>
                        <textarea id="notes" rows="3" placeholder="What did you think about this book?"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="isFavorite">
                            Add to favorites ⭐
                        </label>
                    </div>
                    <button type="submit" class="submit-btn">Add Book 📚</button>
                </form>
            </div>

            <!-- Suggestions Page -->
            <div id="suggestions" class="page">
                <h2>Book Suggestions</h2>
                <div class="form-group">
                    <select id="categoryFilter" onchange="filterSuggestions()">
                        <option value="all">All Categories</option>
                        <option value="classic">Classic Picture Books</option>
                        <option value="bedtime">Bedtime Stories</option>
                        <option value="learning">Early Learning</option>
                        <option value="adventure">Adventure</option>
                        <option value="animals">Animal Stories</option>
                        <option value="rhymes">Nursery Rhymes</option>
                        <option value="seasonal">Seasonal & Holiday</option>
                    </select>
                </div>
                <div class="suggestion-lists" id="suggestionLists"></div>
            </div>

            <!-- Library Page -->
            <div id="library" class="page">
                <h2>Your Library</h2>
                <div class="form-group">
                    <input type="search" id="searchBooks" placeholder="Search books..." oninput="searchBooks()">
                </div>
                <div class="library-grid" id="libraryGrid">
                    <p style="color: #6c757d; text-align: center; grid-column: 1/-1;">Your library is empty. Start adding books!</p>
                </div>
            </div>

            <!-- Badges Page -->
            <div id="badges" class="page">
                <h2>Your Badges</h2>
                <div class="badges-grid" id="badgesGrid"></div>
            </div>

            <!-- Milestones Page -->
            <div id="milestones" class="page">
                <h2>Reading Milestones</h2>
                <div class="badges-grid" id="milestonesGrid"></div>
            </div>

            <!-- Games Page -->
            <div id="games" class="page">
                <h2>Reading Games</h2>
                <div class="games-intro">
                    <p>Complete reading challenges to unlock fun games!</p>
                </div>

                <!-- Subject Badges Section -->
                <div id="subjectBadgesSection" style="margin: 30px 0;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">📚 Subject Badges</h3>
                    <p style="color: #6c757d; margin-bottom: 20px;">Read 3 or more books from any category to earn a subject badge!</p>
                    <div id="subjectBadgesGrid" class="badges-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <!-- Subject badges will be displayed here -->
                    </div>
                </div>

                <div class="games-grid" id="gamesGrid"></div>

                <!-- Dog Park Dash Game -->
                <div id="dogParkGame" class="mini-game" style="display: none;">
                    <div class="game-header">
                        <h3>🐕 Dog Park Dash!</h3>
                        <button class="game-close-btn" onclick="closeGame('dogPark')">✕</button>
                    </div>
                    <div class="game-instructions">
                        <p>Use ⬆️⬇️ arrow keys to move! Collect bones 🦴 for points!</p>
                        <p style="color: #dc3545; font-weight: bold;">⚠️ AVOID THE SQUIRRELS! 🐿️ You have 3 lives!</p>
                    </div>
                    <div class="game-stats">
                        <div class="stat-item">
                            <span class="stat-label">Score:</span>
                            <span id="parkScore">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Time:</span>
                            <span id="parkTimer">60</span>s
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Bones:</span>
                            <span id="bonesCollected">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Lives:</span>
                            <span id="livesLeft">❤️❤️❤️</span>
                        </div>
                    </div>
                    <div class="park-game-area" id="parkGameArea">
                        <div class="park-background"></div>
                        <div class="dog-character" id="dogCharacter">🐕</div>
                        <div class="game-items" id="gameItems"></div>
                    </div>
                    <div class="dog-fact-display" id="dogFactDisplay" style="display: none;">
                        <h4>🐾 Fun Dog Fact!</h4>
                        <p id="dogFactText"></p>
                        <button class="game-btn" onclick="continuePlaying()" style="margin-top: 10px;">Continue Playing ▶️</button>
                    </div>
                    <div class="game-controls">
                        <button class="game-btn" onclick="startParkGame()">▶️ Start</button>
                        <button class="game-btn" onclick="pauseParkGame()" id="pauseBtn">⏸️ Pause</button>
                        <button class="game-btn" onclick="resetParkGame()">🔄 New Game</button>
                    </div>
                    <div class="game-controls" style="margin-top: 10px;">
                        <label style="margin-right: 10px;">Speed: <strong id="currentSpeedLabel" style="color: #28a745;">Normal (1x)</strong></label>
                        <button class="game-btn speed-btn" onclick="setGameSpeed(0.5, this)" style="padding: 5px 10px;">Slow</button>
                        <button class="game-btn speed-btn" onclick="setGameSpeed(1, this)" style="padding: 5px 10px;">Normal</button>
                        <button class="game-btn speed-btn" onclick="setGameSpeed(1.5, this)" style="padding: 5px 10px;">Fast</button>
                    </div>
                    <div class="high-score">
                        🏆 High Score: <span id="parkHighScore">0</span>
                    </div>
                </div>
            </div>

            <!-- Snowflake Catcher Game -->
            <div id="snowflakeGame" class="mini-game" style="display: none;">
                <div class="game-header">
                    <h3>❄️ Snowflake Catcher!</h3>
                    <button class="game-close-btn" onclick="closeGame('snowflake')">✕</button>
                </div>
                <div class="game-instructions">
                    <p>Move your glove to catch falling snowflakes!</p>
                    <p style="color: #4169E1;">⛄ Every 10 catches builds a snowman part (40 total to win!)</p>
                    <p style="color: #28a745;">🎯 Keep combos alive by not missing any!</p>
                    <p style="color: #dc3545;">⛔ Miss 10 snowflakes and you lose!</p>
                </div>
                <div class="game-stats">
                    <div class="stat-item">
                        <span class="stat-label">Caught:</span>
                        <span id="snowCaught">0</span>/40
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Time:</span>
                        <span id="snowTimer">60</span>s
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Combo:</span>
                        <span id="snowCombo" style="font-size: 1.2em; font-weight: bold;">0</span> in a row
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Best Combo:</span>
                        <span id="snowMaxCombo">0</span>
                    </div>
                </div>
                <div class="snow-game-area" id="snowGameArea">
                    <div class="snow-background"></div>
                    <div class="snow-catcher" id="snowCatcher">🧤</div>
                    <div class="falling-items" id="fallingItems"></div>
                    <div id="snowmanDisplay" style="position: absolute; bottom: 10px; right: 10px; font-size: 40px; line-height: 0.7; text-align: center;"></div>
                    <div style="position: absolute; bottom: 5px; right: 100px; font-size: 12px; color: #666;">Build Snowman →</div>
                    <div id="missedDisplay" style="position: absolute; top: 10px; right: 10px; color: #dc3545; font-weight: bold;">Missed: 0/10</div>
                </div>
                <div class="game-controls">
                    <button class="game-btn" onclick="startSnowGame()">▶️ Start</button>
                    <button class="game-btn" onclick="pauseSnowGame()" id="snowPauseBtn">⏸️ Pause</button>
                    <button class="game-btn" onclick="resetSnowGame()">🔄 New Game</button>
                </div>
                <div class="game-controls" style="margin-top: 10px;">
                    <label style="margin-right: 10px;">Speed: <strong id="currentSnowSpeed" style="color: #17a2b8;">Normal (1x)</strong></label>
                    <button class="game-btn snow-speed-btn" onclick="setSnowSpeed(0.5, this)" style="padding: 5px 10px;">Slow</button>
                    <button class="game-btn snow-speed-btn" onclick="setSnowSpeed(1, this)" style="padding: 5px 10px;">Normal</button>
                    <button class="game-btn snow-speed-btn" onclick="setSnowSpeed(1.5, this)" style="padding: 5px 10px;">Fast</button>
                </div>
                <div class="high-score">
                    🏆 Best Combo: <span id="snowBestCombo">0</span> in a row
                </div>
            </div>

            <!-- Dragon Maze Game -->
            <div id="dragonMazeGame" class="mini-game" style="display: none;">
                <div class="game-header">
                    <h3>🐉 Dragon Maze Adventure!</h3>
                    <button class="game-close-btn" onclick="closeGame('dragonMaze')">✕</button>
                </div>
                <div class="game-instructions" style="padding: 8px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                    <div style="margin-bottom: 5px;">
                        <button class="maze-difficulty-btn" onclick="setMazeDifficulty('easy', this)" style="padding: 5px 10px; margin: 2px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 0.85em;">Easy (5x5)</button>
                        <button class="maze-difficulty-btn" onclick="setMazeDifficulty('medium', this)" style="padding: 5px 10px; margin: 2px; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 0.85em;">Medium (7x7)</button>
                        <button class="maze-difficulty-btn" onclick="setMazeDifficulty('hard', this)" style="padding: 5px 10px; margin: 2px; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 0.85em;">Hard (10x10)</button>
                    </div>
                    <p style="margin: 3px 0; font-size: 0.9em;">🐉 Guide to 👸 | Moves: <span id="mazeMovesCount" style="font-weight: bold;">0</span>/<span id="mazeMoveLimit">50</span> | Level: <span id="mazeLevel">1</span> | Best: <span id="mazeBestMoves">--</span></p>
                    <p style="margin: 3px 0; font-size: 0.9em; color: #28a745; font-weight: bold;">✓ Complete in <span id="maxMoves">50</span> moves or less!</p>
                </div>
                <div class="maze-game-area" id="mazeGameArea">
                    <canvas id="mazeCanvas" width="300" height="300"></canvas>
                    <div id="mazeOverlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: white; align-items: center; justify-content: center; font-size: 24px; font-weight: bold;"></div>
                </div>
                <div class="game-controls" style="margin: 5px 0;">
                    <button class="game-btn" onclick="startMazeGame()" style="padding: 5px 10px; font-size: 0.9em;">▶️ New</button>
                    <button class="game-btn" onclick="resetMaze()" style="padding: 5px 10px; font-size: 0.9em;">🔄 Reset</button>
                    <button class="game-btn" onclick="showMazeHint()" style="padding: 5px 10px; font-size: 0.9em;">💡 Hint</button>
                </div>
                <div class="game-controls" style="margin: 5px 0;">
                    <button class="maze-arrow-btn" onclick="moveDragon('up')" style="grid-column: 2; padding: 10px 15px;">⬆️</button>
                    <button class="maze-arrow-btn" onclick="moveDragon('left')" style="grid-column: 1; padding: 10px 15px;">⬅️</button>
                    <button class="maze-arrow-btn" onclick="moveDragon('down')" style="grid-column: 2; padding: 10px 15px;">⬇️</button>
                    <button class="maze-arrow-btn" onclick="moveDragon('right')" style="grid-column: 3; padding: 10px 15px;">➡️</button>
                </div>
                <div class="high-score" style="font-size: 0.9em; margin-top: 5px;">
                    🏆 Best: <span id="mazeFastestRescue">--</span> moves
                </div>
            </div>

            <!-- Sliding Puzzle Game -->
            <div id="slidingPuzzleGame" class="mini-game" style="display: none;">
                <div class="game-header">
                    <h3>🧩 Sliding Puzzle!</h3>
                    <button class="game-close-btn" onclick="closeGame('slidingPuzzle')">✕</button>
                </div>
                <div class="game-instructions" style="padding: 8px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                    <div style="margin-bottom: 5px;">
                        <button class="puzzle-difficulty-btn" onclick="setPuzzleDifficulty('easy', this)" style="padding: 5px 10px; margin: 2px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 0.85em;">Easy (3x3)</button>
                        <button class="puzzle-difficulty-btn" onclick="setPuzzleDifficulty('medium', this)" style="padding: 5px 10px; margin: 2px; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 0.85em;">Medium (4x4)</button>
                        <button class="puzzle-difficulty-btn" onclick="setPuzzleDifficulty('hard', this)" style="padding: 5px 10px; margin: 2px; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 0.85em;">Hard (5x5)</button>
                    </div>
                    <div style="margin-bottom: 5px;">
                        <button onclick="togglePuzzleMode()" style="padding: 5px 10px; margin: 2px; background: #764ba2; color: white; border: none; border-radius: 5px; font-size: 0.85em;">🎼️/1️⃣ Toggle Mode</button>
                        <button onclick="changePuzzleImage()" style="padding: 5px 10px; margin: 2px; background: #764ba2; color: white; border: none; border-radius: 5px; font-size: 0.85em;">🌄 Change Picture</button>
                    </div>
                    <p style="margin: 3px 0; font-size: 0.9em;">Moves: <span id="puzzleMovesCount" style="font-weight: bold;">0</span> | Best: <span id="puzzleBestMoves">--</span> | Mode: <span id="puzzleMode">Picture</span></p>
                </div>
                <div class="puzzle-game-area" id="puzzleGameArea" style="position: relative; height: 320px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; padding: 10px; display: flex; align-items: center; justify-content: center;">
                    <div id="puzzleGrid" style="display: grid; gap: 1px; background: rgba(0,0,0,0.2); padding: 1px; border-radius: 10px;">
                        <!-- Puzzle tiles will be generated here -->
                    </div>
                </div>
                <div class="game-controls" style="margin: 10px 0; text-align: center;">
                    <button class="game-btn" onclick="startPuzzleGame()" style="padding: 8px 15px; font-size: 0.9em; background: #28a745; color: white; border: none; border-radius: 5px; margin: 0 5px;">🎮 New Game</button>
                    <button class="game-btn" onclick="shufflePuzzle()" style="padding: 8px 15px; font-size: 0.9em; background: #17a2b8; color: white; border: none; border-radius: 5px; margin: 0 5px;">🔄 Shuffle</button>
                </div>
                <div id="puzzleComplete" style="display: none; text-align: center; padding: 10px; background: #28a745; color: white; border-radius: 8px; margin-top: 10px;">
                    <h4>🎉 Congratulations! 🎉</h4>
                    <p>Solved in <span id="puzzleFinalMoves">0</span> moves!</p>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settings" class="page">
                <h2>Settings</h2>
                <div class="form-group">
                    <label for="childName">Child's Name</label>
                    <input type="text" id="childName" placeholder="Enter child's name">
                </div>
                <div class="form-group">
                    <label for="birthDate">Birth Date</label>
                    <input type="date" id="birthDate">
                </div>
                <div class="form-group">
                    <label for="dailyGoal">Daily Reading Goal</label>
                    <select id="dailyGoal">
                        <option value="1">1 book</option>
                        <option value="2">2 books</option>
                        <option value="3" selected>3 books</option>
                        <option value="4">4 books</option>
                        <option value="5">5 books</option>
                    </select>
                </div>
                <button class="submit-btn" onclick="saveSettings()">Save Settings</button>

                <!-- Data Management Section -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <h3 style="margin-bottom: 15px;">Data Management</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="submit-btn" style="background: #28a745;" onclick="exportData()">📥 Export Backup</button>
                        <button class="submit-btn" style="background: #17a2b8;" onclick="document.getElementById('importFile').click()">📤 Import Backup</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    </div>
                    <button class="submit-btn" style="background: #dc3545; margin-top: 20px; width: 100%;" onclick="clearData()">🗑️ Clear All Data</button>
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <small style="color: #6c757d;">
                            <strong>Backup Tips:</strong><br>
                            • Export regularly to save your progress<br>
                            • Import to restore from a previous backup<br>
                            • Backups include all children, books, and settings
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // App Version - UPDATE THIS WHEN YOU MAKE CHANGES!
        const APP_VERSION = '1.0.1';

        // App State
        let appData = {
            children: [],
            currentChild: null,
            books: [],
            settings: {
                dailyGoal: 3,
                streakNotifications: true
            },
            streaks: {}  // Will store streak data per child
        };

        let selectedRating = '';
        let currentGame = null;
        let parkGameData = {
            score: 0,
            bonesCollected: 0,
            timeLeft: 60,
            timerInterval: null,
            gameActive: false,
            paused: false,
            factPaused: false,
            highScore: 0,
            dogPosition: { x: 50, y: 300 },
            items: [],
            itemSpawnInterval: null,
            gameSpeed: 1,
            baseSpeed: 1,
            factsUnlocked: [],
            lives: 3
        };

        let snowGameData = {
            caught: 0,
            timeLeft: 60,
            combo: 0,
            maxCombo: 0,
            bestCombo: 0,
            timerInterval: null,
            gameActive: false,
            paused: false,
            snowflakes: [],
            spawnInterval: null,
            catcherX: 0,
            catcherY: 0,
            snowmanParts: 0,
            missedSnowflakes: 0,
            maxMissed: 10,
            gameSpeed: 1,
            baseSpeed: 1
        };

        let testMode = false;

        // Sliding Puzzle Game Data
        let puzzleGameData = {
            gridSize: 3,
            tiles: [],
            moves: 0,
            isComplete: false,
            difficulty: 'easy',
            bestMoves: null,
            gameActive: false,
            mode: 'picture', // 'numbers' or 'picture'
            currentImage: 0
        };

        // Dragon Maze Game Data
        let mazeGameData = {
            walls: { horizontal: [], vertical: [] }, // Store walls between cells
            mazeSize: 5, // Default to easy 5x5
            cellSize: 0,
            dragon: { x: 0, y: 0 },
            princess: { x: 0, y: 0 },
            obstacles: [],
            path: [],
            moves: 0,
            maxMoves: 50, // Default to easy 50 moves
            level: 1,
            gameActive: false,
            bestMoves: null,
            canvas: null,
            ctx: null,
            difficulty: 'easy' // Track current difficulty
        };

        // Dog facts database
        const dogFacts = [
            "A Greyhound can run up to 45 mph - faster than most cars in the city!",
            "Dalmatians are born completely white and develop their spots as they grow.",
            "A dog's nose print is unique, just like a human's fingerprint!",
            "The Basenji is known as the 'barkless dog' - it yodels instead!",
            "Dogs have three eyelids - one for extra eye protection.",
            "Newfoundland dogs have webbed feet and are excellent swimmers.",
            "The Beatles song 'A Day in the Life' has a frequency only dogs can hear at the end.",
            "Bloodhounds can track scents that are over 300 hours old.",
            "Corgis were originally bred to herd cattle - their short legs helped them avoid kicks!",
            "The Norwegian Lundehund has 6 toes on each foot.",
            "Dogs prefer to poop aligned with Earth's magnetic field (North-South).",
            "Snoopy from Peanuts is a Beagle - one of the most popular comic book dogs!",
            "Clifford the Big Red Dog would weigh about 87 tons if he were real!",
            "Three dogs survived the Titanic sinking - all were in first class.",
            "Dogs can learn over 150 words and can count to 4 or 5."
        ];

        // Book Suggestions loaded from external file
//         // const bookSuggestions = {
//             classic: {
//                 name: "Popular Characters",
//                 emoji: "⭐",
//                 books: [
//                     { title: "The Very Hungry Caterpillar", author: "Eric Carle", age: "2-5" },
//                     { title: "Curious George", author: "H.A. Rey", age: "3-6" },
//                     { title: "If You Give a Mouse a Cookie", author: "Laura Numeroff", age: "3-6" },
//                     { title: "Don't Let the Pigeon Drive the Bus!", author: "Mo Willems", age: "3-6" },
//                     { title: "Elephant and Piggie: There Is a Bird on Your Head!", author: "Mo Willems", age: "3-6" },
//                     { title: "The Gruffalo", author: "Julia Donaldson", age: "3-6" },
//                     { title: "Chicka Chicka Boom Boom", author: "Bill Martin Jr.", age: "2-5" },
//                     { title: "Knuffle Bunny", author: "Mo Willems", age: "2-5" },
//                     { title: "The Pigeon Needs a Bath!", author: "Mo Willems", age: "3-6" },
//                     { title: "Press Here", author: "Hervé Tullet", age: "2-5" }
//                 ]
//             },
//             bedtime: {
//                 name: "Dr. Seuss Favorites",
//                 emoji: "🎩",
//                 books: [
//                     { title: "The Cat in the Hat", author: "Dr. Seuss", age: "3-7" },
//                     { title: "Green Eggs and Ham", author: "Dr. Seuss", age: "2-6" },
//                     { title: "One Fish Two Fish Red Fish Blue Fish", author: "Dr. Seuss", age: "2-6" },
//                     { title: "Fox in Socks", author: "Dr. Seuss", age: "3-7" },
//                     { title: "Hop on Pop", author: "Dr. Seuss", age: "2-5" },
//                     { title: "The Cat in the Hat Comes Back", author: "Dr. Seuss", age: "3-7" },
//                     { title: "Oh, the Places You'll Go!", author: "Dr. Seuss", age: "3-7" },
//                     { title: "How the Grinch Stole Christmas", author: "Dr. Seuss", age: "3-7" },
//                     { title: "Horton Hears a Who!", author: "Dr. Seuss", age: "3-7" },
//                     { title: "The Lorax", author: "Dr. Seuss", age: "3-7" }
//                 ]
//             },
//             learning: {
//                 name: "Disney & Pixar Friends",
//                 emoji: "🏰",
//                 books: [
//                     { title: "Frozen: A Sister More Like Me", author: "Disney", age: "3-6" },
//                     { title: "Moana: The Ocean Calls", author: "Disney", age: "3-6" },
//                     { title: "Finding Nemo: Ocean of Color", author: "Disney-Pixar", age: "3-6" },
//                     { title: "The Lion King", author: "Disney", age: "3-6" },
//                     { title: "Toy Story: Woody's New Friend", author: "Disney-Pixar", age: "3-6" },
//                     { title: "Cars: The Spooky Sound", author: "Disney-Pixar", age: "3-6" },
//                     { title: "Encanto: The Magic Within", author: "Disney", age: "3-6" },
//                     { title: "Tangled: Rapunzel's Tale", author: "Disney", age: "3-6" },
//                     { title: "Mickey Mouse Clubhouse: Mickey's Easter Hunt", author: "Disney", age: "2-5" },
//                     { title: "Winnie the Pooh: The Honey Tree", author: "Disney", age: "2-5" }
//                 ]
//             },
//             dogs: {
//                 name: "Favorite Series Characters",
//                 emoji: "📚",
//                 books: [
//                     { title: "Clifford the Big Red Dog", author: "Norman Bridwell", age: "2-5" },
//                     { title: "Pete the Cat: I Love My White Shoes", author: "Eric Litwin", age: "3-6" },
//                     { title: "Biscuit", author: "Alyssa Satin Capucilli", age: "1-3" },
//                     { title: "Spot's First Walk", author: "Eric Hill", age: "0-3" },
//                     { title: "Dog Man", author: "Dav Pilkey", age: "5-8" },
//                     { title: "Bluey: The Beach", author: "Bluey", age: "3-6" },
//                     { title: "PAW Patrol: The Great Pirate Rescue!", author: "Nickelodeon", age: "3-6" },
//                     { title: "Go, Dog. Go!", author: "P.D. Eastman", age: "2-5" },
//                     { title: "Harry the Dirty Dog", author: "Gene Zion", age: "3-6" },
//                     { title: "Skippyjon Jones", author: "Judy Schachner", age: "3-6" }
//                 ]
//             },
//             cats: {
//                 name: "Cat Stories",
//                 emoji: "🐱",
//                 books: [
//                     { title: "Pete the Cat: I Love My White Shoes", author: "Eric Litwin", age: "3-6" },
//                     { title: "The Cat in the Hat", author: "Dr. Seuss", age: "3-7" },
//                     { title: "Splat the Cat", author: "Rob Scotton", age: "3-6" },
//                     { title: "Millions of Cats", author: "Wanda Gág", age: "3-6" },
//                     { title: "The Three Little Kittens", author: "Paul Galdone", age: "2-5" },
//                     { title: "Bad Kitty", author: "Nick Bruel", age: "4-7" },
//                     { title: "Cookie's Week", author: "Cindy Ward", age: "2-5" },
//                     { title: "Kitten's First Full Moon", author: "Kevin Henkes", age: "2-5" },
//                     { title: "The Cat Who Came In Off The Roof", author: "Annie M.G. Schmidt", age: "4-7" },
//                     { title: "Six Dinner Sid", author: "Inga Moore", age: "3-6" }
//                 ]
//             },
//             nature: {
//                 name: "Nature & Outdoors",
//                 emoji: "🌳",
//                 books: [
//                     { title: "The Curious Garden", author: "Peter Brown", age: "4-7" },
//                     { title: "We Are the Gardeners", author: "Joanna Gaines", age: "4-7" },
//                     { title: "The Thing About Bees", author: "Shabazz Larkin", age: "4-7" },
//                     { title: "The Tiny Seed", author: "Eric Carle", age: "3-6" },
//                     { title: "A Tree Is Nice", author: "Janice May Udry", age: "3-6" },
//                     { title: "The Giving Tree", author: "Shel Silverstein", age: "4-7" },
//                     { title: "Planting a Rainbow", author: "Lois Ehlert", age: "2-5" },
//                     { title: "In the Tall, Tall Grass", author: "Denise Fleming", age: "2-5" },
//                     { title: "The Dandelion Seed", author: "Joseph Anthony", age: "4-7" },
//                     { title: "Up in the Garden and Down in the Dirt", author: "Kate Messner", age: "5-8" }
//                 ]
//             },
//             adventure: {
//                 name: "Adventure Stories",
//                 emoji: "🚀",
//                 books: [
//                     { title: "We're Going on a Bear Hunt", author: "Michael Rosen", age: "3-6" },
//                     { title: "The Little Engine That Could", author: "Watty Piper", age: "3-6" },
//                     { title: "Harold and the Purple Crayon", author: "Crockett Johnson", age: "3-6" },
//                     { title: "Oh, the Places You'll Go!", author: "Dr. Seuss", age: "3-7" },
//                     { title: "The Adventures of Beekle", author: "Dan Santat", age: "3-6" },
//                     { title: "Not a Box", author: "Antoinette Portis", age: "2-5" },
//                     { title: "Journey", author: "Aaron Becker", age: "4-7" },
//                     { title: "Where the Sidewalk Ends", author: "Shel Silverstein", age: "4-7" },
//                     { title: "The Snail and the Whale", author: "Julia Donaldson", age: "3-6" },
//                     { title: "Rosie's Walk", author: "Pat Hutchins", age: "2-5" }
//                 ]
//             },
//             pirates: {
//                 name: "Pirates & Treasure",
//                 emoji: "🏴‍☠️",
//                 books: [
//                     { title: "How I Became a Pirate", author: "Melinda Long", age: "4-7" },
//                     { title: "Pirates Don't Change Diapers", author: "Melinda Long", age: "4-7" },
//                     { title: "Shiver Me Letters", author: "June Sobel", age: "3-6" },
//                     { title: "The Night Pirates", author: "Peter Harris", age: "3-6" },
//                     { title: "Pirate Pete's Talk Like a Pirate", author: "Kim Kennedy", age: "3-6" },
//                     { title: "This Little Pirate", author: "Philemon Sturges", age: "2-5" },
//                     { title: "Pirates Love Underpants", author: "Claire Freedman", age: "3-6" },
//                     { title: "The Pirate Cruncher", author: "Jonny Duddle", age: "4-7" },
//                     { title: "Port Side Pirates", author: "Oscar Seaworthy", age: "3-6" },
//                     { title: "Goldilocks and the Three Pirates", author: "April Jones Prince", age: "4-7" }
//                 ]
//             },
//             dinosaurs: {
//                 name: "Dinosaur Adventures",
//                 emoji: "🦕",
//                 books: [
//                     { title: "How Do Dinosaurs Say Goodnight?", author: "Jane Yolen", age: "2-5" },
//                     { title: "Dinosaurs Love Underpants", author: "Claire Freedman", age: "3-6" },
//                     { title: "If the Dinosaurs Came Back", author: "Bernard Most", age: "3-6" },
//                     { title: "The Dinosaur Alphabet Book", author: "Jerry Pallotta", age: "4-7" },
//                     { title: "Goldilocks and the Three Dinosaurs", author: "Mo Willems", age: "3-6" },
//                     { title: "Danny and the Dinosaur", author: "Syd Hoff", age: "3-6" },
//                     { title: "Digging Up Dinosaurs", author: "Aliki", age: "4-7" },
//                     { title: "Dinosaur Bones", author: "Bob Barner", age: "3-6" },
//                     { title: "Dinosaurs, Dinosaurs", author: "Byron Barton", age: "2-5" },
//                     { title: "Dinosaur Roar!", author: "Paul and Henrietta Stickland", age: "2-5" }
//                 ]
//             },
//             christmas: {
//                 name: "Christmas Stories",
//                 emoji: "🎄",
//                 books: [
//                     { title: "The Polar Express", author: "Chris Van Allsburg", age: "3-7" },
//                     { title: "How the Grinch Stole Christmas", author: "Dr. Seuss", age: "3-7" },
//                     { title: "The Night Before Christmas", author: "Clement C. Moore", age: "3-7" },
//                     { title: "The Snowman", author: "Raymond Briggs", age: "2-6" },
//                     { title: "Olive, the Other Reindeer", author: "Vivian Walsh", age: "3-6" },
//                     { title: "The Little Drummer Boy", author: "Ezra Jack Keats", age: "3-6" },
//                     { title: "Bear Stays Up for Christmas", author: "Karma Wilson", age: "2-5" },
//                     { title: "The Christmas Wish", author: "Lori Evert", age: "4-7" },
//                     { title: "Dream Snow", author: "Eric Carle", age: "2-5" },
//                     { title: "Merry Christmas, Big Hungry Bear!", author: "Don and Audrey Wood", age: "2-5" }
//                 ]
//             },
//             thanksgiving: {
//                 name: "Thanksgiving Stories",
//                 emoji: "🦃",
//                 books: [
//                     { title: "Turkey Trouble", author: "Wendi Silvano", age: "3-6" },
//                     { title: "The Thankful Book", author: "Todd Parr", age: "2-5" },
//                     { title: "'Twas the Night Before Thanksgiving", author: "Dav Pilkey", age: "4-7" },
//                     { title: "Bear Says Thanks", author: "Karma Wilson", age: "2-5" },
//                     { title: "The Perfect Thanksgiving", author: "Eileen Spinelli", age: "3-6" },
//                     { title: "Thanksgiving Is for Giving Thanks", author: "Margaret Sutherland", age: "2-5" },
//                     { title: "Balloons Over Broadway", author: "Melissa Sweet", age: "4-7" },
//                     { title: "Gracias the Thanksgiving Turkey", author: "Joy Cowley", age: "3-6" },
//                     { title: "Pete the Cat: The First Thanksgiving", author: "James Dean", age: "3-6" },
//                     { title: "10 Fat Turkeys", author: "Tony Johnston", age: "2-5" }
//                 ]
//             },
//             halloween: {
//                 name: "Halloween Stories",
//                 emoji: "🎃",
//                 books: [
//                     { title: "Room on the Broom", author: "Julia Donaldson", age: "3-6" },
//                     { title: "It's the Great Pumpkin, Charlie Brown", author: "Charles M. Schulz", age: "3-7" },
//                     { title: "The Little Old Lady Who Was Not Afraid of Anything", author: "Linda Williams", age: "3-6" },
//                     { title: "Big Pumpkin", author: "Erica Silverman", age: "3-6" },
//                     { title: "Five Little Pumpkins", author: "Iris Van Rynbach", age: "2-5" },
//                     { title: "Skeleton Hiccups", author: "Margery Cuyler", age: "3-6" },
//                     { title: "The Biggest Pumpkin Ever", author: "Steven Kroll", age: "3-6" },
//                     { title: "Click, Clack, Boo!", author: "Doreen Cronin", age: "3-6" },
//                     { title: "Creepy Carrots!", author: "Aaron Reynolds", age: "4-7" },
//                     { title: "The Monster at the End of This Book", author: "Jon Stone", age: "2-5" }
//                 ]
//             },
//             winter: {
//                 name: "Winter Stories",
//                 emoji: "❄️",
//                 books: [
//                     { title: "The Snowy Day", author: "Ezra Jack Keats", age: "2-5" },
//                     { title: "The Mitten", author: "Jan Brett", age: "3-6" },
//                     { title: "Owl Moon", author: "Jane Yolen", age: "3-7" },
//                     { title: "The Snowman", author: "Raymond Briggs", age: "2-6" },
//                     { title: "Snow", author: "Uri Shulevitz", age: "2-5" },
//                     { title: "The Jacket I Wear in the Snow", author: "Shirley Neitzel", age: "2-5" },
//                     { title: "Over and Under the Snow", author: "Kate Messner", age: "4-7" },
//                     { title: "Snowflake Bentley", author: "Jacqueline Briggs Martin", age: "5-8" },
//                     { title: "Ten on the Sled", author: "Kim Norman", age: "2-5" },
//                     { title: "The First Day of Winter", author: "Denise Fleming", age: "2-5" }
//                 ]
//             },
//             spring: {
//                 name: "Spring Stories",
//                 emoji: "🌷",
//                 books: [
//                     { title: "The Curious Garden", author: "Peter Brown", age: "4-7" },
//                     { title: "Planting a Rainbow", author: "Lois Ehlert", age: "2-5" },
//                     { title: "The Carrot Seed", author: "Ruth Krauss", age: "2-5" },
//                     { title: "It's Spring!", author: "Linda Glaser", age: "3-6" },
//                     { title: "When Spring Comes", author: "Kevin Henkes", age: "3-6" },
//                     { title: "The Thing About Spring", author: "Daniel Kirk", age: "3-6" },
//                     { title: "Mouse's First Spring", author: "Lauren Thompson", age: "0-3" },
//                     { title: "Spring Is Here", author: "Taro Gomi", age: "2-5" },
//                     { title: "Hurray for Spring!", author: "Patricia Hubbell", age: "2-5" },
//                     { title: "And Then It's Spring", author: "Julie Fogliano", age: "3-6" }
//                 ]
//             },
//             summer: {
//                 name: "Summer Stories",
//                 emoji: "☀️",
//                 books: [
//                     { title: "The Watermelon Seed", author: "Greg Pizzoli", age: "2-5" },
//                     { title: "A Perfect Day", author: "Lane Smith", age: "3-6" },
//                     { title: "The Sandcastle That Lola Built", author: "Megan Maynor", age: "3-6" },
//                     { title: "Maisy Goes to the Beach", author: "Lucy Cousins", age: "0-3" },
//                     { title: "Beach Day", author: "Karen Roosa", age: "2-5" },
//                     { title: "Summer Days and Nights", author: "Wong Herbert Yee", age: "3-6" },
//                     { title: "Come On, Rain!", author: "Karen Hesse", age: "3-6" },
//                     { title: "The Summer My Father Was Ten", author: "Pat Brisson", age: "4-7" },
//                     { title: "How to Catch a Star", author: "Oliver Jeffers", age: "3-6" },
//                     { title: "The Night Before Summer Vacation", author: "Natasha Wing", age: "3-6" }
//                 ]
//             },
//             fall: {
//                 name: "Fall/Autumn Stories",
//                 emoji: "🍂",
//                 books: [
//                     { title: "Leaf Man", author: "Lois Ehlert", age: "3-6" },
//                     { title: "We're Going on a Leaf Hunt", author: "Steve Metzger", age: "2-5" },
//                     { title: "Red Leaf, Yellow Leaf", author: "Lois Ehlert", age: "3-6" },
//                     { title: "The Busy Little Squirrel", author: "Nancy Tafuri", age: "2-5" },
//                     { title: "Fall Is Not Easy", author: "Marty Kelley", age: "3-6" },
//                     { title: "Goodbye Summer, Hello Autumn", author: "Kenard Pak", age: "3-6" },
//                     { title: "Awesome Autumn", author: "Bruce Goldstone", age: "3-6" },
//                     { title: "The Apple Pie Tree", author: "Zoe Hall", age: "2-5" },
//                     { title: "Leaves", author: "David Ezra Stein", age: "2-5" },
//                     { title: "Fall Mixed Up", author: "Bob Raczka", age: "3-6" }
//                 ]
//             },
//             classic: {
//                 name: "Classic Picture Books",
//                 emoji: "📖",
//                 books: [
//                     { title: "The Very Hungry Caterpillar", author: "Eric Carle", age: "2-5" },
//                     { title: "Where the Wild Things Are", author: "Maurice Sendak", age: "3-6" },
//                     { title: "Goodnight Moon", author: "Margaret Wise Brown", age: "0-3" },
//                     { title: "The Cat in the Hat", author: "Dr. Seuss", age: "3-7" },
//                     { title: "Corduroy", author: "Don Freeman", age: "3-5" },
//                     { title: "Curious George", author: "H.A. Rey", age: "3-6" },
//                     { title: "The Rainbow Fish", author: "Marcus Pfister", age: "3-6" },
//                     { title: "Brown Bear, Brown Bear, What Do You See?", author: "Bill Martin Jr.", age: "0-3" },
//                     { title: "Madeline", author: "Ludwig Bemelmans", age: "3-6" },
//                     { title: "The Little House", author: "Virginia Lee Burton", age: "3-6" }
//                 ]
//             },
//             bedtime: {
//                 name: "Dr. Seuss Favorites",
//                 emoji: "🎩",
//                 books: [
//                     { title: "The Cat in the Hat", author: "Dr. Seuss", age: "3-7" },
//                     { title: "Green Eggs and Ham", author: "Dr. Seuss", age: "2-6" },
//                     { title: "One Fish Two Fish Red Fish Blue Fish", author: "Dr. Seuss", age: "2-6" },
//                     { title: "Fox in Socks", author: "Dr. Seuss", age: "3-7" },
//                     { title: "Hop on Pop", author: "Dr. Seuss", age: "2-5" },
//                     { title: "The Cat in the Hat Comes Back", author: "Dr. Seuss", age: "3-7" },
//                     { title: "Oh, the Places You'll Go!", author: "Dr. Seuss", age: "3-7" },
//                     { title: "How the Grinch Stole Christmas", author: "Dr. Seuss", age: "3-7" },
//                     { title: "Horton Hears a Who!", author: "Dr. Seuss", age: "3-7" },
//                     { title: "The Lorax", author: "Dr. Seuss", age: "3-7" }
//                 ]
//             },
//             rhymes: {
//                 name: "Nursery Rhymes",
//                 emoji: "🎵",
//                 books: [
//                     { title: "Mother Goose's Nursery Rhymes", author: "Various", age: "0-5" },
//                     { title: "The Real Mother Goose", author: "Blanche Fisher Wright", age: "0-5" },
//                     { title: "Mary Engelbreit's Mother Goose", author: "Mary Engelbreit", age: "0-5" },
//                     { title: "Tomie dePaola's Mother Goose", author: "Tomie dePaola", age: "0-5" },
//                     { title: "Richard Scarry's Best Mother Goose Ever", author: "Richard Scarry", age: "0-5" },
//                     { title: "Each Peach Pear Plum", author: "Janet & Allan Ahlberg", age: "0-3" },
//                     { title: "Hickory Dickory Dock", author: "Keith Baker", age: "0-3" },
//                     { title: "Hey Diddle Diddle", author: "Salley Mavor", age: "0-3" },
//                     { title: "Pat-a-Cake", author: "Mary Brigid Barrett", age: "0-3" },
//                     { title: "This Little Piggy", author: "Jane Yolen", age: "0-3" }
//                 ]
//             }
//         // }; // Book suggestions now loaded from js/bookSuggestions.js

        // Milestones
        const milestones = [
            { books: 10, name: "First Chapter", emoji: "📖" },
            { books: 25, name: "Bookworm", emoji: "🐛" },
            { books: 50, name: "Page Turner", emoji: "📄" },
            { books: 100, name: "Century Reader", emoji: "💯" },
            { books: 250, name: "Quarter Master", emoji: "🎯" },
            { books: 500, name: "Halfway Hero", emoji: "🌟" },
            { books: 750, name: "Super Reader", emoji: "🦸" },
            { books: 1000, name: "Champion!", emoji: "🏆" }
        ];

        // Badges
        const badges = [
            // Getting Started
            { id: 'first-book', name: 'First Book', description: 'Read your first book!', emoji: '📘', condition: (books) => books.length >= 1 },
            { id: 'first-five', name: 'High Five', description: 'Read 5 books', emoji: '✋', condition: (books) => books.length >= 5 },
            { id: 'double-digits', name: 'Double Digits', description: 'Read 10 books', emoji: '🔟', condition: (books) => books.length >= 10 },

            // Streaks & Consistency
            { id: 'week-streak', name: 'Week Streak', description: '7 day reading streak', emoji: '🔥', condition: (books) => calculateStreak(books) >= 7 },
            { id: 'fortnight-streak', name: 'Two Week Wonder', description: '14 day reading streak', emoji: '💫', condition: (books) => calculateStreak(books) >= 14 },
            { id: 'month-streak', name: 'Monthly Master', description: '30 day reading streak', emoji: '🏅', condition: (books) => calculateStreak(books) >= 30 },
            { id: 'weekend-warrior', name: 'Weekend Warrior', description: 'Read on 5 consecutive weekends', emoji: '🦸', condition: (books) => checkWeekendStreak(books) >= 5 },


            // Favorites & Ratings
            { id: 'favorite-finder', name: 'Favorite Finder', description: 'Mark 5 books as favorites', emoji: '⭐', condition: (books) => books.filter(b => b.isFavorite).length >= 5 },
            { id: 'super-fan', name: 'Super Fan', description: 'Mark 20 books as favorites', emoji: '🌟', condition: (books) => books.filter(b => b.isFavorite).length >= 20 },
            { id: 'love-reader', name: 'Book Lover', description: 'Rate 10 books as "Loved it!"', emoji: '💖', condition: (books) => books.filter(b => b.rating === 'love').length >= 10 },
            { id: 'critic', name: 'Little Critic', description: 'Rate 25 books with any rating', emoji: '🎓', condition: (books) => books.filter(b => b.rating).length >= 25 },

            // Speed & Volume
            { id: 'speed-reader', name: 'Speed Reader', description: 'Read 10 books in one week', emoji: '⚡', condition: (books) => checkWeeklyBooks(books) >= 10 },
            { id: 'marathon-reader', name: 'Marathon Reader', description: 'Read 5 books in one day', emoji: '🏃', condition: (books) => checkDailyMax(books) >= 5 },
            { id: 'century-club', name: 'Century Club', description: 'Read 100 books total', emoji: '💯', condition: (books) => books.length >= 100 },

            // Variety
            { id: 'variety-reader', name: 'Variety Reader', description: 'Read books from 10 different authors', emoji: '🌈', condition: (books) => new Set(books.map(b => b.author).filter(a => a)).size >= 10 },
            { id: 'author-fan', name: 'Author Fan', description: 'Read 5 books by the same author', emoji: '✍️', condition: (books) => checkSameAuthor(books) >= 5 },

            // Major Milestones
            { id: 'quarter-century', name: 'Quarter Century', description: 'Read 25 books', emoji: '📚', condition: (books) => books.length >= 25 },
            { id: 'half-century', name: 'Half Century', description: 'Read 50 books', emoji: '📖', condition: (books) => books.length >= 50 },
            { id: 'bookworm-legend', name: 'Bookworm Legend', description: 'Read 250 books', emoji: '🏆', condition: (books) => books.length >= 250 },
            { id: 'reading-champion', name: 'Reading Champion', description: 'Read 500 books', emoji: '👑', condition: (books) => books.length >= 500 },
            { id: 'ultimate-bookworm', name: 'Ultimate Bookworm', description: 'Read 1000 books!', emoji: '🎯', condition: (books) => books.length >= 1000 },

            // Time Patterns
            { id: 'new-year-starter', name: 'New Year Starter', description: 'Read a book in first week of January', emoji: '🎊', condition: (books) => checkNewYearStarter(books) },
            { id: 'holiday-season', name: 'Holiday Season', description: 'Read 10 books in December', emoji: '🎄', condition: (books) => checkDecemberReading(books) >= 10 },
            { id: 'back-to-school', name: 'Back to School', description: 'Read 15 books in September', emoji: '🎒', condition: (books) => checkSeptemberReading(books) >= 15 },
            { id: 'spring-reader', name: 'Spring Reader', description: 'Read 20 books in March, April, or May', emoji: '🌸', condition: (books) => checkSpringReading(books) >= 20 },
            { id: 'winter-warrior', name: 'Winter Warrior', description: 'Read 20 books in Dec, Jan, or Feb', emoji: '❄️', condition: (books) => checkWinterReading(books) >= 20 },
            { id: 'summer-reader', name: 'Summer Reader', description: 'Read 30 books in June, July, or August', emoji: '☀️', condition: (books) => checkSummerReading(books) >= 30 },

            // Monthly Achievements
            { id: 'monthly-champion', name: 'Monthly Champion', description: 'Read 30+ books in a single month', emoji: '🏅', condition: (books) => checkMonthlyMax(books) >= 30 },
            { id: 'consistent-reader', name: 'Consistent Reader', description: 'Read at least 1 book every month for 6 months', emoji: '📆', condition: (books) => checkMonthlyConsistency(books) >= 6 },
            { id: 'year-long-reader', name: 'Year-Long Reader', description: 'Read at least 1 book every month for 12 months', emoji: '🗓️', condition: (books) => checkMonthlyConsistency(books) >= 12 },
            { id: 'book-a-day', name: 'Book-a-Day', description: 'Read every single day for an entire month', emoji: '📅', condition: (books) => checkFullMonthStreak(books) },

            // Growth & Improvement
            { id: 'rising-star', name: 'Rising Star', description: 'Increase reading 3 months in a row', emoji: '📈', condition: (books) => checkRisingStreak(books) >= 3 },
            { id: 'double-up', name: 'Double Up', description: 'Read twice as many books as previous month', emoji: '⏫', condition: (books) => checkDoubleUp(books) },
            { id: 'personal-best', name: 'Personal Best', description: 'Beat your highest monthly record', emoji: '🥇', condition: (books) => checkPersonalBest(books) },

            // Category Explorer
            { id: 'explorer', name: 'Explorer', description: 'Read from 5 different categories', emoji: '🗺️', condition: (books) => new Set(books.map(b => b.category).filter(c => c)).size >= 5 },
            { id: 'category-master', name: 'Category Master', description: 'Read from all available categories', emoji: '🎨', condition: (books) => checkAllCategories(books) },
            { id: 'category-champion', name: 'Category Champion', description: 'Read 10+ books in a single category', emoji: '🏵️', condition: (books) => checkCategoryMax(books) >= 10 },

            // Reading Times
            { id: 'weekday-warrior', name: 'Weekday Warrior', description: 'Read Monday-Friday for 2 weeks straight', emoji: '💼', condition: (books) => checkWeekdayStreak(books) >= 10 },
            { id: 'early-achiever', name: 'Early Achiever', description: 'Complete 100 books in your first year', emoji: '🌟', condition: (books) => checkEarlyAchiever(books) },

            // Special Achievements
            { id: 'rereader', name: 'Repeat Reader', description: 'Read the same book 3 times', emoji: '🔄', condition: (books) => checkRereads(books) >= 3 }
        ];

        // Initialize App
        function initApp() {
            loadData();
            updateChildSelector();
            setTodaysDate();
            updateDashboard();
            initializeBadges();
            initializeMilestones();
            checkForUpdates();
            registerServiceWorker();
            populateCategoryDropdown();
            setupSuggestionListeners();
        }

        // Populate Category Dropdown
        function populateCategoryDropdown() {
            const categorySelect = document.getElementById('bookCategory');
            if (categorySelect) {
                // Clear existing options except the first one
                categorySelect.innerHTML = '<option value="">Select a category...</option>';

                // Add all categories from bookSuggestions
                Object.entries(bookSuggestions).forEach(([key, category]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${category.emoji} ${category.name}`;
                    categorySelect.appendChild(option);
                });
            }
        }

        // Register Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('Service Worker registered');

                    // Listen for updates from service worker
                    navigator.serviceWorker.addEventListener('message', event => {
                        if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                            showUpdateBanner(event.data.version);
                        }
                    });

                    // Check for updates periodically (every 30 minutes)
                    setInterval(() => {
                        registration.update();
                    }, 30 * 60 * 1000);
                }).catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
            }
        }

        // Check for Updates
        function checkForUpdates() {
            const lastVersion = localStorage.getItem('appVersion');

            if (lastVersion && lastVersion !== APP_VERSION) {
                // User has an older version, show what's new
                showToast(`Updated to version ${APP_VERSION}! 🎉`);
            }

            // Save current version
            localStorage.setItem('appVersion', APP_VERSION);
        }

        // Show Update Banner
        function showUpdateBanner(newVersion) {
            const banner = document.getElementById('updateBanner');
            banner.classList.add('show');

            // Also save that an update is available
            localStorage.setItem('updateAvailable', 'true');
        }

        // Update Now
        function updateNow() {
            // Clear cache and reload
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            location.reload(true);
        }

        // Dismiss Update
        function dismissUpdate() {
            const banner = document.getElementById('updateBanner');
            banner.classList.remove('show');

            // Show reminder in 1 hour
            setTimeout(() => {
                if (localStorage.getItem('updateAvailable') === 'true') {
                    showUpdateBanner();
                }
            }, 60 * 60 * 1000);
        }

        // Load Data
        function loadData() {
            const saved = localStorage.getItem('1000BooksApp');
            if (saved) {
                appData = JSON.parse(saved);
            }
        }

        // Save Data
        function saveData() {
            localStorage.setItem('1000BooksApp', JSON.stringify(appData));
        }

        // Update Child Selector
        function updateChildSelector() {
            const selector = document.getElementById('childSelect');
            selector.innerHTML = '<option value="">Select Child</option>';

            appData.children.forEach((child, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = child.name;
                selector.appendChild(option);
            });

            // Add option to create new child
            const addOption = document.createElement('option');
            addOption.value = 'new';
            addOption.textContent = '➕ Add New Child';
            selector.appendChild(addOption);
        }

        // Switch Child
        function switchChild(value) {
            if (value === 'new') {
                const name = prompt('Enter child\'s name:');
                if (name) {
                    const newChild = {
                        id: Date.now(),
                        name: name,
                        birthDate: '',
                        books: []
                    };
                    appData.children.push(newChild);
                    appData.currentChild = appData.children.length - 1;
                    saveData();
                    updateChildSelector();
                    document.getElementById('childSelect').value = appData.currentChild;
                    updateDashboard();
                }
            } else if (value !== '') {
                appData.currentChild = parseInt(value);
                saveData();
                updateDashboard();
            }
        }

        // Show Page
        function showPage(pageName, buttonElement) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageName).classList.add('active');

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            if (pageName === 'library') {
                displayLibrary();
            } else if (pageName === 'suggestions') {
                displaySuggestions();
            } else if (pageName === 'games') {
                displayGames();
            }
        }

        // Streak Management Functions
        function getStreakData(childId) {
            // Initialize streaks object if it doesn't exist
            if (!appData.streaks) {
                appData.streaks = {};
            }

            if (!appData.streaks[childId]) {
                appData.streaks[childId] = {
                    currentStreak: 0,
                    longestStreak: 0,
                    lastReadDate: null,
                    freezeUsed: false
                };
            }
            return appData.streaks[childId];
        }

        function updateStreak(childId) {
            const streak = getStreakData(childId);
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();

            if (streak.lastReadDate === today) {
                // Already read today, no change
                return streak.currentStreak;
            }

            if (streak.lastReadDate === yesterday) {
                // Continuing streak
                streak.currentStreak++;
                streak.lastReadDate = today;
            } else if (!streak.lastReadDate || getDaysBetween(new Date(streak.lastReadDate), new Date()) > 2) {
                // Starting new streak or broke streak
                streak.currentStreak = 1;
                streak.lastReadDate = today;
                streak.freezeUsed = false;
            } else if (getDaysBetween(new Date(streak.lastReadDate), new Date()) === 2 && !streak.freezeUsed) {
                // Use one-time freeze (missed one day)
                streak.freezeUsed = true;
                streak.lastReadDate = today;
                showToast('🧊 Streak freeze used! Your streak continues!');
            } else {
                // Broke streak
                streak.currentStreak = 1;
                streak.lastReadDate = today;
                streak.freezeUsed = false;
            }

            // Update longest streak
            if (streak.currentStreak > streak.longestStreak) {
                streak.longestStreak = streak.currentStreak;

                // Celebrate milestones
                if (appData.settings.streakNotifications) {
                    if (streak.currentStreak === 7) {
                        showToast('🔥 Amazing! 7 day streak!');
                    } else if (streak.currentStreak === 30) {
                        showToast('🔥🔥 Incredible! 30 day streak!');
                    } else if (streak.currentStreak === 100) {
                        showToast('🔥🔥🔥 LEGENDARY! 100 day streak!');
                    }
                }
            }

            saveData();
            return streak.currentStreak;
        }

        function getDaysBetween(date1, date2) {
            const oneDay = 24 * 60 * 60 * 1000;
            return Math.round(Math.abs((date2 - date1) / oneDay));
        }

        function getStreakEmoji(days) {
            if (days === 0) return '💤';
            if (days < 3) return '🔥';
            if (days < 7) return '🔥🔥';
            if (days < 30) return '🔥🔥🔥';
            return '🔥🔥🔥🔥';
        }

        // Update Dashboard
        function updateDashboard() {
            if (appData.currentChild === null || !appData.children[appData.currentChild]) {
                document.getElementById('bookCount').textContent = '0';
                return;
            }

            const child = appData.children[appData.currentChild];
            const books = child.books || [];

            // Update book count
            document.getElementById('bookCount').textContent = books.length;

            // Update progress circle
            const progress = (books.length / 1000) * 565;
            document.getElementById('progressCircle').style.strokeDashoffset = 565 - progress;

            // Update stats
            document.getElementById('daysActive').textContent = calculateDaysActive(books);
            document.getElementById('thisWeek').textContent = calculateThisWeek(books);
            document.getElementById('favorites').textContent = books.filter(b => b.isFavorite).length;
            // Update streak display with emoji
            if (appData.children[appData.currentChild]) {
                const childId = appData.children[appData.currentChild].id;
                const streakData = getStreakData(childId);
                const streakElement = document.getElementById('streak');
                streakElement.textContent = streakData.currentStreak;

                // Add visual feedback for streak
                const streakCard = streakElement.parentElement;
                const emojiElement = streakCard.querySelector('.stat-emoji');
                emojiElement.textContent = getStreakEmoji(streakData.currentStreak);
            }

            // Update recent books
            displayRecentBooks(books);

            // Update milestone tracker
            updateMilestoneTracker(books.length);
        }

        // Update Milestone Tracker
        function updateMilestoneTracker(bookCount) {
            const tracker = document.getElementById('milestoneTracker');
            const nextMilestone = milestones.find(m => m.books > bookCount);

            if (nextMilestone) {
                tracker.style.display = 'block';
                document.getElementById('milestoneProgress').textContent = `${bookCount} / ${nextMilestone.books} books`;
                document.getElementById('nextMilestone').textContent = `${nextMilestone.emoji} ${nextMilestone.name}`;
            } else {
                tracker.style.display = 'none';
            }
        }

        // Calculate Days Active
        function calculateDaysActive(books) {
            if (books.length === 0) return 0;
            const dates = [...new Set(books.map(b => b.readDate))];
            return dates.length;
        }

        // Calculate This Week
        function calculateThisWeek(books) {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            return books.filter(b => new Date(b.readDate) >= weekAgo).length;
        }

        // Check Weekly Books
        function checkWeeklyBooks(books) {
            let maxWeekly = 0;
            const sortedBooks = books.sort((a, b) => new Date(a.readDate) - new Date(b.readDate));

            for (let i = 0; i < sortedBooks.length; i++) {
                const weekEnd = new Date(sortedBooks[i].readDate);
                weekEnd.setDate(weekEnd.getDate() + 7);
                const weekBooks = sortedBooks.filter(b =>
                    new Date(b.readDate) >= new Date(sortedBooks[i].readDate) &&
                    new Date(b.readDate) < weekEnd
                ).length;
                maxWeekly = Math.max(maxWeekly, weekBooks);
            }
            return maxWeekly;
        }

        // Calculate Streak
        function calculateStreak(books) {
            if (books.length === 0) return 0;

            const dates = [...new Set(books.map(b => b.readDate))].sort().reverse();
            const today = new Date().toISOString().split('T')[0];

            if (dates[0] !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (dates[0] !== yesterday.toISOString().split('T')[0]) {
                    return 0;
                }
            }

            let streak = 1;
            for (let i = 1; i < dates.length; i++) {
                const prevDate = new Date(dates[i - 1]);
                const currDate = new Date(dates[i]);
                const dayDiff = (prevDate - currDate) / (1000 * 60 * 60 * 24);

                if (dayDiff === 1) {
                    streak++;
                } else {
                    break;
                }
            }

            return streak;
        }

        // Check Weekend Streak
        function checkWeekendStreak(books) {
            if (books.length === 0) return 0;

            const weekendDates = books
                .filter(b => {
                    const date = new Date(b.readDate);
                    const day = date.getDay();
                    return day === 0 || day === 6; // Sunday or Saturday
                })
                .map(b => b.readDate);

            if (weekendDates.length === 0) return 0;

            // Group by weekend
            const weekends = new Set();
            weekendDates.forEach(dateStr => {
                const date = new Date(dateStr);
                const weekStart = new Date(date);
                if (date.getDay() === 0) { // Sunday
                    weekStart.setDate(date.getDate() - 1);
                }
                while (weekStart.getDay() !== 6) { // Find Saturday
                    weekStart.setDate(weekStart.getDate() - 1);
                }
                weekends.add(weekStart.toISOString().split('T')[0]);
            });

            // Check for consecutive weekends
            const sortedWeekends = Array.from(weekends).sort().reverse();
            let maxStreak = 1;
            let currentStreak = 1;

            for (let i = 1; i < sortedWeekends.length; i++) {
                const prevWeekend = new Date(sortedWeekends[i - 1]);
                const currWeekend = new Date(sortedWeekends[i]);
                const dayDiff = (prevWeekend - currWeekend) / (1000 * 60 * 60 * 24);

                if (dayDiff === 7) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 1;
                }
            }

            return maxStreak;
        }

        // Check Daily Maximum
        function checkDailyMax(books) {
            if (books.length === 0) return 0;

            const booksByDate = {};
            books.forEach(book => {
                if (!booksByDate[book.readDate]) {
                    booksByDate[book.readDate] = 0;
                }
                booksByDate[book.readDate]++;
            });

            return Math.max(...Object.values(booksByDate));
        }

        // Check Same Author
        function checkSameAuthor(books) {
            if (books.length === 0) return 0;

            const authorCounts = {};
            books.forEach(book => {
                if (book.author) {
                    if (!authorCounts[book.author]) {
                        authorCounts[book.author] = 0;
                    }
                    authorCounts[book.author]++;
                }
            });

            return Math.max(...Object.values(authorCounts), 0);
        }

        // Check Series
        // Check Summer Reading
        function checkSummerReading(books) {
            if (books.length === 0) return 0;

            return books.filter(book => {
                const date = new Date(book.readDate);
                const month = date.getMonth();
                return month >= 5 && month <= 7; // June (5), July (6), August (7)
            }).length;
        }

        // New Year Starter - Read in first week of January
        function checkNewYearStarter(books) {
            return books.some(book => {
                const date = new Date(book.readDate);
                const month = date.getMonth();
                const day = date.getDate();
                return month === 0 && day <= 7; // January, first 7 days
            });
        }

        // December Reading
        function checkDecemberReading(books) {
            return books.filter(book => {
                const date = new Date(book.readDate);
                return date.getMonth() === 11; // December
            }).length;
        }

        // September Reading
        function checkSeptemberReading(books) {
            return books.filter(book => {
                const date = new Date(book.readDate);
                return date.getMonth() === 8; // September
            }).length;
        }

        // Spring Reading (March, April, May)
        function checkSpringReading(books) {
            return books.filter(book => {
                const date = new Date(book.readDate);
                const month = date.getMonth();
                return month >= 2 && month <= 4; // March (2), April (3), May (4)
            }).length;
        }

        // Winter Reading (December, January, February)
        function checkWinterReading(books) {
            return books.filter(book => {
                const date = new Date(book.readDate);
                const month = date.getMonth();
                return month === 11 || month === 0 || month === 1; // Dec, Jan, Feb
            }).length;
        }

        // Check Monthly Max
        function checkMonthlyMax(books) {
            if (books.length === 0) return 0;

            const monthlyCount = {};
            books.forEach(book => {
                const date = new Date(book.readDate);
                const key = `${date.getFullYear()}-${date.getMonth()}`;
                monthlyCount[key] = (monthlyCount[key] || 0) + 1;
            });

            return Math.max(...Object.values(monthlyCount), 0);
        }

        // Check Monthly Consistency
        function checkMonthlyConsistency(books) {
            if (books.length === 0) return 0;

            const monthlyBooks = {};
            books.forEach(book => {
                const date = new Date(book.readDate);
                const key = `${date.getFullYear()}-${date.getMonth()}`;
                monthlyBooks[key] = true;
            });

            const months = Object.keys(monthlyBooks).sort();
            if (months.length === 0) return 0;

            let maxStreak = 1;
            let currentStreak = 1;

            for (let i = 1; i < months.length; i++) {
                const [prevYear, prevMonth] = months[i - 1].split('-').map(Number);
                const [currYear, currMonth] = months[i].split('-').map(Number);

                const monthDiff = (currYear - prevYear) * 12 + (currMonth - prevMonth);
                if (monthDiff === 1) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 1;
                }
            }

            return maxStreak;
        }

        // Check Full Month Streak
        function checkFullMonthStreak(books) {
            if (books.length === 0) return false;

            const dailyBooks = {};
            books.forEach(book => {
                const date = new Date(book.readDate);
                const key = date.toISOString().split('T')[0];
                dailyBooks[key] = `${date.getFullYear()}-${date.getMonth()}`;
            });

            const monthlyDays = {};
            Object.entries(dailyBooks).forEach(([day, month]) => {
                if (!monthlyDays[month]) {
                    monthlyDays[month] = new Set();
                }
                const date = new Date(day);
                monthlyDays[month].add(date.getDate());
            });

            return Object.entries(monthlyDays).some(([month, days]) => {
                const [year, monthNum] = month.split('-').map(Number);
                const daysInMonth = new Date(year, monthNum + 1, 0).getDate();
                return days.size === daysInMonth;
            });
        }

        // Check Rising Streak
        function checkRisingStreak(books) {
            if (books.length === 0) return 0;

            const monthlyCount = {};
            books.forEach(book => {
                const date = new Date(book.readDate);
                const key = `${date.getFullYear()}-${String(date.getMonth()).padStart(2, '0')}`;
                monthlyCount[key] = (monthlyCount[key] || 0) + 1;
            });

            const sortedMonths = Object.entries(monthlyCount)
                .sort(([a], [b]) => a.localeCompare(b))
                .map(([, count]) => count);

            let maxStreak = 0;
            let currentStreak = 0;

            for (let i = 1; i < sortedMonths.length; i++) {
                if (sortedMonths[i] > sortedMonths[i - 1]) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
            }

            return maxStreak + 1; // +1 because we count transitions
        }

        // Check Double Up
        function checkDoubleUp(books) {
            if (books.length === 0) return false;

            const monthlyCount = {};
            books.forEach(book => {
                const date = new Date(book.readDate);
                const key = `${date.getFullYear()}-${String(date.getMonth()).padStart(2, '0')}`;
                monthlyCount[key] = (monthlyCount[key] || 0) + 1;
            });

            const sortedMonths = Object.entries(monthlyCount).sort(([a], [b]) => a.localeCompare(b));

            for (let i = 1; i < sortedMonths.length; i++) {
                if (sortedMonths[i][1] >= sortedMonths[i - 1][1] * 2) {
                    return true;
                }
            }

            return false;
        }

        // Check Personal Best
        function checkPersonalBest(books) {
            if (books.length === 0) return false;

            const monthlyCount = {};
            books.forEach(book => {
                const date = new Date(book.readDate);
                const key = `${date.getFullYear()}-${String(date.getMonth()).padStart(2, '0')}`;
                monthlyCount[key] = (monthlyCount[key] || 0) + 1;
            });

            const counts = Object.values(monthlyCount);
            if (counts.length < 2) return false;

            const sortedCounts = [...counts].sort((a, b) => b - a);
            const latestMonth = Object.keys(monthlyCount).sort().pop();
            const latestCount = monthlyCount[latestMonth];

            return latestCount === sortedCounts[0] && latestCount > sortedCounts[1];
        }

        // Check All Categories
        function checkAllCategories(books) {
            const usedCategories = new Set(books.map(b => b.category).filter(c => c));
            const totalCategories = Object.keys(bookSuggestions || {}).length;
            return totalCategories > 0 && usedCategories.size === totalCategories;
        }

        // Check Category Max
        function checkCategoryMax(books) {
            if (books.length === 0) return 0;

            const categoryCount = {};
            books.forEach(book => {
                if (book.category) {
                    categoryCount[book.category] = (categoryCount[book.category] || 0) + 1;
                }
            });

            return Math.max(...Object.values(categoryCount), 0);
        }

        // Check Weekday Streak
        function checkWeekdayStreak(books) {
            if (books.length === 0) return 0;

            const weekdayDates = books
                .map(book => new Date(book.readDate))
                .filter(date => {
                    const day = date.getDay();
                    return day >= 1 && day <= 5; // Monday to Friday
                })
                .map(date => date.toISOString().split('T')[0])
                .sort();

            if (weekdayDates.length === 0) return 0;

            let maxStreak = 0;
            let currentStreak = 1;
            let lastDate = new Date(weekdayDates[0]);

            for (let i = 1; i < weekdayDates.length; i++) {
                const currentDate = new Date(weekdayDates[i]);
                const dayDiff = Math.floor((currentDate - lastDate) / (1000 * 60 * 60 * 24));

                // Check if consecutive weekday (accounting for weekends)
                if (dayDiff === 1 || (dayDiff === 3 && lastDate.getDay() === 5)) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 1;
                }

                lastDate = currentDate;
            }

            return Math.max(maxStreak, 1);
        }

        // Check Early Achiever
        function checkEarlyAchiever(books) {
            if (books.length < 100) return false;

            const sortedBooks = [...books].sort((a, b) => new Date(a.readDate) - new Date(b.readDate));
            const firstBook = new Date(sortedBooks[0].readDate);
            const hundredthBook = new Date(sortedBooks[99].readDate);

            const daysDiff = Math.floor((hundredthBook - firstBook) / (1000 * 60 * 60 * 24));
            return daysDiff <= 365;
        }

        // Check Rereads
        function checkRereads(books) {
            if (books.length === 0) return 0;

            const titleCounts = {};
            books.forEach(book => {
                const title = book.title.toLowerCase();
                if (!titleCounts[title]) {
                    titleCounts[title] = 0;
                }
                titleCounts[title]++;
            });

            return Math.max(...Object.values(titleCounts), 0);
        }

        // Display Recent Books
        function displayRecentBooks(books) {
            const container = document.getElementById('recentBooks');
            if (books.length === 0) {
                container.innerHTML = '<p style="color: #6c757d;">No books added yet. Start your reading journey!</p>';
                return;
            }

            const recent = books.slice(-5).reverse();
            container.innerHTML = recent.map(book => `
                <div class="recent-book">
                    <div style="font-weight: bold; margin-bottom: 5px;">${book.title}</div>
                    <div style="font-size: 0.9rem; color: #6c757d;">${book.rating === 'love' ? '😍' : book.rating === 'like' ? '😊' : '😐'}</div>
                </div>
            `).join('');
        }

        // Set Today's Date
        function setTodaysDate() {
            document.getElementById('readDate').value = new Date().toISOString().split('T')[0];
        }

        // Select Rating
        function selectRating(btn, rating) {
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedRating = rating;
        }

        // Add Book
        function addBook(event) {
            event.preventDefault();

            if (appData.currentChild === null) {
                showToast('Please select or add a child first!');
                document.getElementById('childSelect').focus();
                return;
            }

            const book = {
                id: Date.now(),
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                readDate: document.getElementById('readDate').value,
                rating: selectedRating,
                notes: document.getElementById('notes').value,
                isFavorite: document.getElementById('isFavorite').checked,
                category: document.getElementById('bookCategory')?.value || null
            };

            appData.children[appData.currentChild].books.push(book);
            saveData();

            // Update streak
            const childId = appData.children[appData.currentChild].id;
            updateStreak(childId);

            // Check for new badges
            checkBadges();

            // Check if this category just earned a badge (3 books)
            if (book.category && bookSuggestions[book.category]) {
                const booksInCategory = appData.children[appData.currentChild].books.filter(
                    b => b.category === book.category
                ).length;

                if (booksInCategory === 3) {
                    // Just earned a badge for this category!
                    showToast(`🏆 Subject badge earned for ${bookSuggestions[book.category].name}! You've read 3 books in this category!`);

                    // Update badge displays if on games or suggestions page
                    const activePage = document.querySelector('.page.active');
                    if (activePage) {
                        if (activePage.id === 'games') {
                            displaySubjectBadges();
                        } else if (activePage.id === 'suggestions') {
                            displaySuggestions();
                        }
                    }
                }
            }

            // Reset form
            document.getElementById('addBookForm').reset();
            setTodaysDate();
            selectedRating = '';
            document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));

            showToast('Book added successfully! 📚');
            updateDashboard();

            // Check for milestones
            const bookCount = appData.children[appData.currentChild].books.length;
            const milestone = milestones.find(m => m.books === bookCount);
            if (milestone) {
                setTimeout(() => {
                    showToast(`🎉 Milestone reached: ${milestone.name}! ${milestone.emoji}`);
                }, 1000);
            }
        }

        // Display Library
        function displayLibrary() {
            if (appData.currentChild === null || !appData.children[appData.currentChild]) {
                document.getElementById('libraryGrid').innerHTML = '<p style="color: #6c757d; text-align: center;">Please select a child first.</p>';
                return;
            }

            const books = appData.children[appData.currentChild].books || [];
            const container = document.getElementById('libraryGrid');

            if (books.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">Your library is empty. Start adding books!</p>';
                return;
            }

            // Group books by title and author
            const bookGroups = {};
            books.forEach(book => {
                const key = `${book.title}|${book.author || ''}`;
                if (!bookGroups[key]) {
                    bookGroups[key] = {
                        title: book.title,
                        author: book.author,
                        isFavorite: book.isFavorite,
                        category: book.category,
                        count: 0,
                        dates: [],
                        bookIds: []
                    };
                }
                bookGroups[key].count++;
                bookGroups[key].dates.push(book.readDate);
                bookGroups[key].bookIds.push(book);
                // Keep favorite status if any instance is favorite
                if (book.isFavorite) {
                    bookGroups[key].isFavorite = true;
                }
            });

            // Convert to array and sort alphabetically
            const sortedGroups = Object.values(bookGroups).sort((a, b) =>
                a.title.toLowerCase().localeCompare(b.title.toLowerCase())
            );

            // Calculate total books for proper numbering
            let bookNumber = 0;

            // Display as a compact table-like list with grouped books
            container.innerHTML = `
                <div style="width: 100%; background: white; border-radius: 10px; overflow: hidden;">
                    <div style="display: table; width: 100%; border-collapse: collapse;">
                        ${sortedGroups.map(group => {
                            const displayNumber = bookNumber + 1;
                            bookNumber += group.count;
                            return `
                            <div style="
                                display: table-row;
                                transition: background 0.2s;
                            " onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                <div style="
                                    display: table-cell;
                                    padding: 12px 15px;
                                    border-bottom: 1px solid #e9ecef;
                                    width: 60px;
                                    color: #adb5bd;
                                    font-size: 0.85em;
                                    vertical-align: middle;
                                ">${displayNumber}${group.count > 1 ? `-${bookNumber}` : ''}</div>
                                <div style="
                                    display: table-cell;
                                    padding: 12px 15px;
                                    border-bottom: 1px solid #e9ecef;
                                    vertical-align: middle;
                                ">
                                    <span style="font-weight: 600; color: #495057;">
                                        ${group.title} ${group.count > 1 ? `<span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">${group.count}</span>` : ''} ${group.isFavorite ? '⭐' : ''}
                                    </span>
                                    ${group.author ? ` <span style="color: #6c757d; font-size: 0.9em;">— ${group.author}</span>` : ''}
                                </div>
                                <div style="
                                    display: table-cell;
                                    padding: 12px 15px;
                                    border-bottom: 1px solid #e9ecef;
                                    color: #adb5bd;
                                    font-size: 0.85em;
                                    text-align: right;
                                    width: 180px;
                                    vertical-align: middle;
                                ">${group.count > 1 ?
                                    `<span title="${group.dates.map(d => new Date(d).toLocaleDateString()).join(', ')}">First: ${new Date(Math.min(...group.dates.map(d => new Date(d)))).toLocaleDateString()}</span>` :
                                    new Date(group.dates[0]).toLocaleDateString()
                                }</div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }

        // Search Books
        function searchBooks() {
            const query = document.getElementById('searchBooks').value.toLowerCase();
            const books = appData.children[appData.currentChild]?.books || [];

            const filtered = books.filter(book =>
                book.title.toLowerCase().includes(query) ||
                (book.author && book.author.toLowerCase().includes(query))
            );

            const container = document.getElementById('libraryGrid');
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">No books found.</p>';
                return;
            }

            // Group filtered books by title and author
            const bookGroups = {};
            filtered.forEach(book => {
                const key = `${book.title}|${book.author || ''}`;
                if (!bookGroups[key]) {
                    bookGroups[key] = {
                        title: book.title,
                        author: book.author,
                        isFavorite: book.isFavorite,
                        category: book.category,
                        count: 0,
                        dates: [],
                        bookIds: []
                    };
                }
                bookGroups[key].count++;
                bookGroups[key].dates.push(book.readDate);
                bookGroups[key].bookIds.push(book);
                // Keep favorite status if any instance is favorite
                if (book.isFavorite) {
                    bookGroups[key].isFavorite = true;
                }
            });

            // Convert to array and sort alphabetically
            const sortedGroups = Object.values(bookGroups).sort((a, b) =>
                a.title.toLowerCase().localeCompare(b.title.toLowerCase())
            );

            // Calculate total books for proper numbering
            let bookNumber = 0;

            // Display filtered results - grouped format
            container.innerHTML = `
                <div style="width: 100%; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: table; width: 100%; border-collapse: collapse;">
                        <div style="display: table-row; background: #f8f9fa; font-weight: bold;">
                            <div style="display: table-cell; padding: 12px 15px; border-bottom: 2px solid #dee2e6; width: 60px;">#</div>
                            <div style="display: table-cell; padding: 12px 15px; border-bottom: 2px solid #dee2e6;">Book Details</div>
                            <div style="display: table-cell; padding: 12px 15px; border-bottom: 2px solid #dee2e6; width: 140px;">Category</div>
                            <div style="display: table-cell; padding: 12px 15px; border-bottom: 2px solid #dee2e6; width: 180px;">Date Read</div>
                        </div>
                        ${sortedGroups.map(group => {
                            const displayNumber = bookNumber + 1;
                            bookNumber += group.count;
                            return `
                            <div style="display: table-row; transition: background 0.2s;"
                                 onmouseover="this.style.background='#f8f9fa'"
                                 onmouseout="this.style.background='white'">
                                <div style="display: table-cell; padding: 12px 15px; border-bottom: 1px solid #e9ecef; color: #6c757d; vertical-align: top;">
                                    ${displayNumber}${group.count > 1 ? `-${bookNumber}` : ''}
                                </div>
                                <div style="display: table-cell; padding: 12px 15px; border-bottom: 1px solid #e9ecef; vertical-align: top;">
                                    <div style="font-weight: 500; color: #2c3e50;">
                                        ${group.title} ${group.count > 1 ? `<span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">${group.count}</span>` : ''} ${group.isFavorite ? '⭐' : ''}
                                    </div>
                                    ${group.author ? `<div style="color: #6c757d; font-size: 14px; margin-top: 2px;">by ${group.author}</div>` : ''}
                                </div>
                                <div style="display: table-cell; padding: 12px 15px; border-bottom: 1px solid #e9ecef; color: #6c757d; font-size: 14px; vertical-align: top;">
                                    ${group.category && bookSuggestions[group.category] ?
                                        `${bookSuggestions[group.category].emoji} ${bookSuggestions[group.category].name}` : '-'}
                                </div>
                                <div style="display: table-cell; padding: 12px 15px; border-bottom: 1px solid #e9ecef; color: #6c757d; font-size: 14px; vertical-align: top;">
                                    ${group.count > 1 ?
                                        `<span title="${group.dates.map(d => new Date(d).toLocaleDateString()).join(', ')}">First: ${new Date(Math.min(...group.dates.map(d => new Date(d)))).toLocaleDateString()}</span>` :
                                        new Date(group.dates[0]).toLocaleDateString()
                                    }
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }

        // Initialize Badges
        function initializeBadges() {
            const container = document.getElementById('badgesGrid');
            container.innerHTML = badges.map(badge => `
                <div class="badge-card locked" id="badge-${badge.id}">
                    <div class="badge-icon">${badge.emoji}</div>
                    <div class="badge-name">${badge.name}</div>
                    <div class="badge-description">${badge.description}</div>
                </div>
            `).join('');
        }

        // Check Badges
        function checkBadges() {
            if (appData.currentChild === null) return;

            const books = appData.children[appData.currentChild].books || [];

            badges.forEach(badge => {
                const element = document.getElementById(`badge-${badge.id}`);
                if (badge.condition(books)) {
                    element.classList.remove('locked');
                    element.classList.add('earned');
                } else {
                    element.classList.add('locked');
                    element.classList.remove('earned');
                }
            });
        }

        // Initialize Milestones
        function initializeMilestones() {
            const container = document.getElementById('milestonesGrid');
            container.innerHTML = milestones.map(milestone => `
                <div class="badge-card locked" id="milestone-${milestone.books}">
                    <div class="badge-icon">${milestone.emoji}</div>
                    <div class="badge-name">${milestone.name}</div>
                    <div class="badge-description">${milestone.books} books</div>
                </div>
            `).join('');

            updateMilestones();
        }

        // Update Milestones
        function updateMilestones() {
            if (appData.currentChild === null) return;

            const bookCount = appData.children[appData.currentChild]?.books?.length || 0;

            milestones.forEach(milestone => {
                const element = document.getElementById(`milestone-${milestone.books}`);
                if (bookCount >= milestone.books) {
                    element.classList.remove('locked');
                    element.classList.add('earned');
                } else {
                    element.classList.add('locked');
                    element.classList.remove('earned');
                }
            });
        }

        // Save Settings
        function saveSettings() {
            if (appData.currentChild === null) {
                showToast('Please select a child first!');
                return;
            }

            const child = appData.children[appData.currentChild];
            child.name = document.getElementById('childName').value || child.name;
            child.birthDate = document.getElementById('birthDate').value;
            appData.settings.dailyGoal = parseInt(document.getElementById('dailyGoal').value);

            saveData();
            updateChildSelector();
            showToast('Settings saved!');
        }

        // Export Data
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportName = `1000-books-backup-${new Date().toISOString().split('T')[0]}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();

            showToast('Data exported successfully! 💾');
        }

        // Import Data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Validate the imported data structure
                    if (!importedData.children || !Array.isArray(importedData.children)) {
                        throw new Error('Invalid backup file format');
                    }

                    // Confirm before importing
                    const bookCount = importedData.children.reduce((total, child) => total + (child.books?.length || 0), 0);
                    const childCount = importedData.children.length;

                    if (confirm(`Import backup with ${childCount} child profile(s) and ${bookCount} total book(s)? This will replace all current data.`)) {
                        // Import the data
                        appData = importedData;

                        // Ensure required fields exist
                        if (!appData.settings) {
                            appData.settings = { dailyGoal: 3 };
                        }
                        if (!appData.currentChild && appData.children.length > 0) {
                            appData.currentChild = appData.children[0].id;
                        }

                        // Save and refresh
                        saveData();
                        initApp();
                        showToast('Data imported successfully! 📤');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Failed to import data. Please check the file format.', 'error');
                }

                // Reset the file input
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        // Clear Data
        function clearData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone!')) {
                if (confirm('Really sure? All your books and progress will be lost!')) {
                    localStorage.removeItem('1000BooksApp');
                    appData = {
                        children: [],
                        currentChild: null,
                        books: [],
                        settings: { dailyGoal: 3 }
                    };
                    initApp();
                    showToast('All data cleared');
                }
            }
        }

        // Show Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Display Suggestions
        function displaySuggestions() {
            const container = document.getElementById('suggestionLists');
            const filter = document.getElementById('categoryFilter').value;

            container.innerHTML = '';

            // Get current badges to check which categories have been earned
            const earnedBadges = checkSubjectBadges();
            const badgesByCategory = {};
            earnedBadges.forEach(badge => {
                badgesByCategory[badge.category] = badge.count;
            });

            // Get current child's books to check what's been read
            const childBooks = appData.currentChild !== null && appData.children[appData.currentChild]
                ? appData.children[appData.currentChild].books || []
                : [];

            // Create a set of book titles that have been read (for faster lookup)
            const readBookTitles = new Set(childBooks.map(book => book.title.toLowerCase()));

            let categoryIndex = 0;
            for (const [key, category] of Object.entries(bookSuggestions)) {
                if (filter !== 'all' && filter !== key) continue;

                const hasBadge = badgesByCategory[key] !== undefined;
                const bookCount = badgesByCategory[key] || 0;

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'suggestion-category collapsed';
                categoryDiv.id = `category-${key}`;
                categoryDiv.innerHTML = `
                    <div class="suggestion-category-header">
                        <h3>
                            ${category.emoji} ${category.name} <span style="font-size: 0.8em; color: #6c757d;">(${category.books.length} books)</span>
                            ${hasBadge ? `
                                <span style="
                                    display: inline-block;
                                    margin-left: 10px;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    padding: 2px 8px;
                                    border-radius: 12px;
                                    font-size: 0.8em;
                                    font-weight: normal;
                                ">🏆 Badge Earned! (${bookCount} books)</span>
                            ` : ''}
                        </h3>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="suggestion-category-content">
                        <div class="suggestion-books">
                            ${category.books.map((book, index) => {
                                const isRead = readBookTitles.has(book.title.toLowerCase());
                                return `
                                    <div class="suggestion-book">
                                        <div class="suggestion-book-info">
                                            <div class="suggestion-book-title">${book.title}</div>
                                            <div class="suggestion-book-author">by ${book.author}</div>
                                            <div class="suggestion-book-age">Ages ${book.age}</div>
                                        </div>
                                        <button class="add-suggestion-btn ${isRead ? 'added' : ''}"
                                                id="suggest-${key}-${index}"
                                                data-category="${key}"
                                                data-index="${index}"
                                                ${isRead ? 'disabled' : ''}>
                                            ${isRead ? '✓ Read' : 'Add Book'}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(categoryDiv);
                categoryIndex++;
            }

            // Auto-expand first category
            const firstCategory = container.querySelector('.suggestion-category');
            if (firstCategory) {
                firstCategory.classList.remove('collapsed');
            }

        }

        // Set up event delegation for suggestion buttons (call once on page load)
        function setupSuggestionListeners() {
            const container = document.getElementById('suggestionLists');
            if (container) {
                container.addEventListener('click', function(e) {
                    // Handle add book button clicks
                    if (e.target.classList.contains('add-suggestion-btn') && !e.target.disabled) {
                        e.preventDefault();
                        const categoryKey = e.target.dataset.category;
                        const bookIndex = parseInt(e.target.dataset.index);
                        addSuggestedBook(categoryKey, bookIndex);
                    }
                    // Handle category header clicks
                    else if (e.target.closest('.suggestion-category-header')) {
                        e.preventDefault();
                        const header = e.target.closest('.suggestion-category-header');
                        const categoryDiv = header.parentElement;
                        const key = categoryDiv.id.replace('category-', '');
                        toggleCategory(key);
                    }
                });
            }
        }

        // Toggle Category
        function toggleCategory(key) {
            const categoryDiv = document.getElementById(`category-${key}`);
            if (categoryDiv) {
                categoryDiv.classList.toggle('collapsed');
            }
        }

        // Filter Suggestions
        function filterSuggestions() {
            displaySuggestions();
        }

        // Add Suggested Book
        function addSuggestedBook(categoryKey, bookIndex) {
            if (appData.currentChild === null) {
                showToast('Please select or add a child first!');
                document.getElementById('childSelect').focus();
                return;
            }

            // Immediately update button to show it's been read
            const button = document.getElementById(`suggest-${categoryKey}-${bookIndex}`);
            if (button) {
                button.textContent = '✓ Read';
                button.classList.add('added');
                button.disabled = true;
            }

            const book = bookSuggestions[categoryKey].books[bookIndex];
            const today = new Date().toISOString().split('T')[0];

            const newBook = {
                id: Date.now(),
                title: book.title,
                author: book.author,
                readDate: today,
                rating: '',
                notes: `Suggested for ages ${book.age}`,
                isFavorite: false,
                category: categoryKey
            };

            appData.children[appData.currentChild].books.push(newBook);

            // Save data and wait for it to complete
            saveData();

            // Update streak
            const childId = appData.children[appData.currentChild].id;
            updateStreak(childId);

            // Check if this category just earned a badge (3 books)
            const booksInCategory = appData.children[appData.currentChild].books.filter(
                b => b.category === categoryKey
            ).length;

            if (booksInCategory === 3) {
                // Just earned a badge for this category!
                showToast(`🏆 Subject badge earned for ${bookSuggestions[categoryKey].name}! You've read 3 books in this category!`);

                // Update badge displays if on games or suggestions page
                const activePage = document.querySelector('.page.active');
                if (activePage) {
                    if (activePage.id === 'games') {
                        displaySubjectBadges();
                    } else if (activePage.id === 'suggestions') {
                        displaySuggestions();
                    }
                }
            }

            // Check for new badges
            checkBadges();

            // Update dashboard only if we're on the dashboard page
            const activePage = document.querySelector('.page.active');
            if (activePage && activePage.id === 'dashboard') {
                updateDashboard();
            }

            showToast(`Added "${book.title}" to your library! 📚`);

            // Check for milestones
            const bookCount = appData.children[appData.currentChild].books.length;
            const milestone = milestones.find(m => m.books === bookCount);
            if (milestone) {
                setTimeout(() => {
                    showToast(`🎉 Milestone reached: ${milestone.name}! ${milestone.emoji}`);
                }, 1000);
            }
        }

        // Display Games
        function displayGames() {
            const container = document.getElementById('gamesGrid');

            // Display subject badges
            displaySubjectBadges();

            // Check if games should be unlocked
            const unlockedGames = checkUnlockedGames();

            const games = [
                {
                    id: 'dogPark',
                    name: 'Dog Park Dash',
                    icon: '🦴',
                    requirement: 'Read 10 books',
                    unlocked: unlockedGames.dogPark,
                    action: () => startDogParkGame()
                },
                {
                    id: 'letterMatch',
                    name: 'Letter Match',
                    icon: '🔤',
                    requirement: 'Read 25 books',
                    unlocked: unlockedGames.letterMatch,
                    action: () => showToast('Letter Match game coming soon!')
                },
                {
                    id: 'storyTime',
                    name: 'Story Builder',
                    icon: '📝',
                    requirement: 'Read 40 books',
                    unlocked: unlockedGames.storyBuilder,
                    action: () => showToast('Story Builder game coming soon!')
                },
                {
                    id: 'slidingPuzzle',
                    name: 'Sliding Puzzle',
                    icon: '🧩',
                    requirement: 'Read 50 books',
                    unlocked: unlockedGames.slidingPuzzle,
                    action: () => startSlidingPuzzleGame()
                },
                {
                    id: 'snowflake',
                    name: 'Snowflake Catcher',
                    icon: '❄️',
                    requirement: 'Read 75 books',
                    unlocked: unlockedGames.snowflake,
                    action: () => startSnowflakeGame()
                },
                {
                    id: 'dragonMaze',
                    name: 'Dragon Maze',
                    icon: '🐉',
                    requirement: 'Read 100 books',
                    unlocked: unlockedGames.dragonMaze,
                    action: () => startDragonMazeGame()
                },
                {
                    id: 'seasonSort',
                    name: 'Season Sorter',
                    icon: '🍂',
                    requirement: 'Read 150 books',
                    unlocked: unlockedGames.seasonSort,
                    action: () => showToast('Season Sorter game coming soon!')
                }
            ];

            container.innerHTML = games.map(game => `
                <div class="game-card ${game.unlocked ? 'unlocked' : 'locked'}"
                     onclick="${game.unlocked ? `gameActions['${game.id}']()` : 'showLockedMessage()'}">
                    <div class="game-icon">${game.icon}</div>
                    <div class="game-name">${game.name}</div>
                    <div class="game-requirement">
                        ${game.unlocked ? '✓ Unlocked!' : `🔒 ${game.requirement}`}
                    </div>
                </div>
            `).join('');

            // Store game actions globally
            window.gameActions = {
                dogPark: () => startDogParkGame(),
                snowflake: () => startSnowflakeGame(),
                dragonMaze: () => startDragonMazeGame(),
                slidingPuzzle: () => startSlidingPuzzleGame(),
                letterMatch: () => showToast('Letter Match game coming soon!'),
                storyBuilder: () => showToast('Story Builder game coming soon!'),
                seasonSort: () => showToast('Season Sorter game coming soon!')
            };
        }

        // Check Unlocked Games
        function checkUnlockedGames() {
            // Test mode unlocks all games
            if (testMode) {
                return {
                    dogPark: true,
                    snowflake: true,
                    dragonMaze: true,
                    slidingPuzzle: true,
                    letterMatch: true,
                    storyBuilder: true,
                    seasonSort: true
                };
            }

            if (appData.currentChild === null || !appData.children[appData.currentChild]) {
                return {
                    dogPark: false,
                    snowflake: false,
                    dragonMaze: false,
                    slidingPuzzle: false,
                    letterMatch: false,
                    storyBuilder: false,
                    seasonSort: false
                };
            }

            const books = appData.children[appData.currentChild].books || [];
            const totalBooks = books.length;

            // Games unlock based on total books read
            return {
                dogPark: totalBooks >= 10,
                letterMatch: totalBooks >= 25,
                storyBuilder: totalBooks >= 40,
                slidingPuzzle: totalBooks >= 50,
                snowflake: totalBooks >= 75,
                dragonMaze: totalBooks >= 100,
                seasonSort: totalBooks >= 150
            };
        }

        // Check Subject Badges
        function checkSubjectBadges() {
            if (appData.currentChild === null || !appData.children[appData.currentChild]) {
                return [];
            }

            const books = appData.children[appData.currentChild].books || [];
            const categoryCounts = {};

            // Count books per category
            books.forEach(book => {
                if (book.category) {
                    categoryCounts[book.category] = (categoryCounts[book.category] || 0) + 1;
                }
            });

            // Find categories with 3 or more books
            const earnedBadges = [];
            Object.entries(categoryCounts).forEach(([category, count]) => {
                if (count >= 3 && bookSuggestions[category]) {
                    earnedBadges.push({
                        category: category,
                        name: bookSuggestions[category].name,
                        emoji: bookSuggestions[category].emoji,
                        count: count
                    });
                }
            });

            return earnedBadges;
        }

        // Display Subject Badges
        function displaySubjectBadges() {
            const container = document.getElementById('subjectBadgesGrid');
            if (!container) return;

            const badges = checkSubjectBadges();

            if (badges.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #adb5bd; padding: 20px;">No badges earned yet. Read 3 or more books from any category!</div>';
                return;
            }

            container.innerHTML = badges.map(badge => `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 15px;
                    padding: 15px;
                    text-align: center;
                    color: white;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    transition: transform 0.3s;
                    cursor: pointer;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="font-size: 2.5em; margin-bottom: 5px;">${badge.emoji}</div>
                    <div style="font-size: 0.9em; font-weight: bold;">${badge.name}</div>
                    <div style="font-size: 0.8em; opacity: 0.9; margin-top: 5px;">${badge.count} books</div>
                </div>
            `).join('');
        }

        // Show Locked Message
        function showLockedMessage() {
            showToast('Complete the reading challenge to unlock this game! 🔒');
        }

        // Start Dog Park Game
        function startDogParkGame() {
            const gameDiv = document.getElementById('dogParkGame');
            gameDiv.style.display = 'block';

            // Load high score
            parkGameData.highScore = parseInt(localStorage.getItem('parkGameHighScore') || '0');
            document.getElementById('parkHighScore').textContent = parkGameData.highScore;

            // Create overlay
            let overlay = document.getElementById('gameOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'gameOverlay';
                overlay.className = 'game-overlay';
                overlay.onclick = () => closeGame('dogPark');
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'block';

            resetParkGame();

            // Add keyboard controls
            document.addEventListener('keydown', handleKeyPress);

            // Add touch controls for mobile
            setupTouchControls();

            // Initialize Normal speed button as selected
            const speedButtons = document.querySelectorAll('.speed-btn');
            speedButtons.forEach(btn => {
                btn.classList.remove('speed-selected');

                // Keep the padding style but clear other inline styles
                const padding = btn.style.padding;
                btn.style.background = '';
                btn.style.border = '';
                btn.style.transform = '';
                btn.style.boxShadow = '';

                if (btn.textContent === 'Normal') {
                    btn.classList.add('speed-selected');
                }
            });
        }

        // Setup touch controls for mobile
        function setupTouchControls() {
            const gameArea = document.getElementById('parkGameArea');
            if (!gameArea) return;

            let touchStartY = 0;
            let dogStartY = 0;

            gameArea.addEventListener('touchstart', (e) => {
                if (!parkGameData.gameActive || parkGameData.paused) return;
                e.preventDefault();
                touchStartY = e.touches[0].clientY;
                const dog = document.getElementById('dogCharacter');
                dogStartY = parseInt(dog.style.top) || 300;
            }, { passive: false });

            gameArea.addEventListener('touchmove', (e) => {
                if (!parkGameData.gameActive || parkGameData.paused) return;
                e.preventDefault();

                const dog = document.getElementById('dogCharacter');
                const gameArea = document.getElementById('parkGameArea');
                const areaHeight = gameArea.offsetHeight;

                const touchY = e.touches[0].clientY;
                const deltaY = touchY - touchStartY;
                let newTop = dogStartY + deltaY;

                // Keep dog within bounds
                newTop = Math.max(30, Math.min(areaHeight - 60, newTop));
                dog.style.top = newTop + 'px';
                parkGameData.dogPosition.y = newTop;

                // Check for collisions
                checkCollisions();
            }, { passive: false });
        }

        // Handle keyboard input
        function handleKeyPress(e) {
            if (!parkGameData.gameActive || parkGameData.paused) return;

            const dog = document.getElementById('dogCharacter');
            const gameArea = document.getElementById('parkGameArea');
            const areaHeight = gameArea.offsetHeight;

            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    parkGameData.dogPosition.y = Math.max(50, parkGameData.dogPosition.y - 40);
                    dog.classList.add('running');
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    parkGameData.dogPosition.y = Math.min(areaHeight - 60, parkGameData.dogPosition.y + 40);
                    dog.classList.add('running');
                    break;
            }

            dog.style.top = parkGameData.dogPosition.y + 'px';
            setTimeout(() => dog.classList.remove('running'), 200);

            checkCollisions();
        }

        // Start the park game
        function startParkGame() {
            if (parkGameData.gameActive) return;

            parkGameData.gameActive = true;
            parkGameData.paused = false;
            document.getElementById('pauseBtn').textContent = '⏸️ Pause';

            startParkTimer();
            startItemSpawning();
        }

        // Pause game
        function pauseParkGame() {
            if (!parkGameData.gameActive) return;

            parkGameData.paused = !parkGameData.paused;
            document.getElementById('pauseBtn').textContent = parkGameData.paused ? '▶️ Resume' : '⏸️ Pause';
        }

        // Reset park game
        function resetParkGame() {
            // Stop any running timers
            if (parkGameData.timerInterval) clearInterval(parkGameData.timerInterval);
            if (parkGameData.itemSpawnInterval) clearInterval(parkGameData.itemSpawnInterval);

            // Preserve certain values
            const preservedHighScore = parkGameData.highScore || 0;
            const preservedFacts = parkGameData.factsUnlocked || [];
            const preservedBaseSpeed = parkGameData.baseSpeed || 1;

            // Reset game data
            parkGameData = {
                score: 0,
                bonesCollected: 0,
                timeLeft: 60,
                timerInterval: null,
                gameActive: false,
                paused: false,
                factPaused: false,
                highScore: preservedHighScore,
                dogPosition: { x: 50, y: 200 },
                items: [],
                itemSpawnInterval: null,
                gameSpeed: preservedBaseSpeed,
                baseSpeed: preservedBaseSpeed,
                factsUnlocked: preservedFacts,
                lives: 3
            };

            // Reset display
            updateParkDisplay();

            // Clear all existing items and their intervals
            document.querySelectorAll('.game-item').forEach(item => {
                if (item.dataset.moveInterval) {
                    clearInterval(parseInt(item.dataset.moveInterval));
                }
                item.remove();
            });

            // Position dog
            const dog = document.getElementById('dogCharacter');
            dog.style.left = parkGameData.dogPosition.x + 'px';
            dog.style.top = parkGameData.dogPosition.y + 'px';

            // Hide dog fact
            document.getElementById('dogFactDisplay').style.display = 'none';
        }

        // Start park timer
        function startParkTimer() {
            parkGameData.timerInterval = setInterval(() => {
                if (parkGameData.paused) return;

                parkGameData.timeLeft--;

                const timerElement = document.getElementById('parkTimer');
                timerElement.textContent = parkGameData.timeLeft;

                if (parkGameData.timeLeft <= 10) {
                    timerElement.classList.add('timer-warning');
                }

                if (parkGameData.timeLeft <= 0) {
                    endParkGame();
                }
            }, 1000);
        }

        // Spawn items
        function startItemSpawning() {
            parkGameData.itemSpawnInterval = setInterval(() => {
                if (parkGameData.paused || !parkGameData.gameActive) return;

                const itemTypes = [
                    { emoji: '🦴', points: 10, type: 'bone' },
                    { emoji: '🦴', points: 10, type: 'bone' },
                    { emoji: '🦴', points: 10, type: 'bone' }, // More bones
                    { emoji: '🎾', points: 25, type: 'tennis' },
                    { emoji: '🧸', points: 30, type: 'toy' },
                    { emoji: '🥏', points: 35, type: 'frisbee' },
                    { emoji: '🏆', points: 50, type: 'trophy' },
                    { emoji: '🐿️', points: 0, type: 'obstacle' }, // Squirrel obstacle
                    { emoji: '🐿️', points: 0, type: 'obstacle' }  // More squirrels for challenge
                ];

                const item = itemTypes[Math.floor(Math.random() * itemTypes.length)];
                spawnItem(item);
            }, 1500 / parkGameData.gameSpeed);
        }

        // Spawn a single item
        function spawnItem(itemData) {
            const gameArea = document.getElementById('parkGameArea');
            let itemsContainer = document.getElementById('gameItems');

            // Create items container if it doesn't exist
            if (!itemsContainer) {
                itemsContainer = document.createElement('div');
                itemsContainer.id = 'gameItems';
                itemsContainer.className = 'game-items';
                gameArea.appendChild(itemsContainer);
            }

            const item = document.createElement('div');
            item.className = 'game-item';
            item.innerHTML = itemData.emoji;
            item.dataset.points = itemData.points;
            item.dataset.type = itemData.type;

            // Random Y position
            const yPos = Math.random() * (gameArea.offsetHeight - 60) + 30;
            item.style.top = yPos + 'px';
            item.style.right = '-50px';

            itemsContainer.appendChild(item);

            // Move item across screen
            const moveInterval = setInterval(() => {
                // Check collision even when paused (so kids can still collect during fact display)
                if (!item.classList.contains('collected')) {
                    checkSingleItemCollision(item);
                }

                // Don't move if paused, but still check collisions above
                if (parkGameData.paused) return;

                const currentRight = parseInt(item.style.right);
                const newRight = currentRight + (5 * parkGameData.gameSpeed);
                item.style.right = newRight + 'px';

                // Remove if off screen
                if (newRight > gameArea.offsetWidth) {
                    clearInterval(moveInterval);
                    item.remove();
                }
            }, 30);

            item.dataset.moveInterval = moveInterval.toString();
        }

        // Check collisions (for all items when dog moves)
        function checkCollisions() {
            const items = document.querySelectorAll('.game-item:not(.collected)');
            items.forEach(item => {
                checkSingleItemCollision(item);
            });
        }

        // Check collision for a single item
        function checkSingleItemCollision(item) {
            if (item.classList.contains('collected')) return;

            const dog = document.getElementById('dogCharacter');
            const dogRect = dog.getBoundingClientRect();
            const itemRect = item.getBoundingClientRect();

            if (dogRect.left < itemRect.right &&
                dogRect.right > itemRect.left &&
                dogRect.top < itemRect.bottom &&
                dogRect.bottom > itemRect.top) {

                collectItem(item);
            }
        }

        // Collect an item
        function collectItem(item) {
            // Prevent double collection
            if (item.classList.contains('collected')) return;
            item.classList.add('collected');

            const points = parseInt(item.dataset.points);
            const type = item.dataset.type;

            // Handle obstacle collision
            if (type === 'obstacle') {
                handleObstacleHit(item);
                return;
            }

            parkGameData.score += points;
            if (type === 'bone') {
                parkGameData.bonesCollected++;

                // Unlock a dog fact every 5 bones
                if (parkGameData.bonesCollected % 5 === 0) {
                    showDogFact();
                }
            }

            // Show score popup
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.textContent = `+${points}`;
            const itemRect = item.getBoundingClientRect();
            const gameArea = document.getElementById('parkGameArea');
            const gameRect = gameArea.getBoundingClientRect();
            popup.style.left = (itemRect.left - gameRect.left) + 'px';
            popup.style.top = (itemRect.top - gameRect.top) + 'px';
            gameArea.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);

            // Clear movement interval and animate collection
            if (item.dataset.moveInterval) {
                clearInterval(parseInt(item.dataset.moveInterval));
            }
            setTimeout(() => item.remove(), 500);

            updateParkDisplay();
        }

        // Show dog fact
        function showDogFact() {
            // Pause the game
            if (parkGameData.gameActive && !parkGameData.paused) {
                parkGameData.paused = true;
                parkGameData.factPaused = true; // Track that fact caused the pause
            }

            const factDisplay = document.getElementById('dogFactDisplay');
            const factText = document.getElementById('dogFactText');

            // Get random fact not already shown
            const unusedFacts = dogFacts.filter((fact, index) =>
                !parkGameData.factsUnlocked.includes(index));

            if (unusedFacts.length > 0) {
                const factIndex = dogFacts.indexOf(unusedFacts[Math.floor(Math.random() * unusedFacts.length)]);
                parkGameData.factsUnlocked.push(factIndex);
                factText.textContent = dogFacts[factIndex];
                factDisplay.style.display = 'block';

                // Don't auto-hide - wait for user to click continue
            } else if (dogFacts.length > 0) {
                // If all facts shown, recycle them
                const randomFact = dogFacts[Math.floor(Math.random() * dogFacts.length)];
                factText.textContent = randomFact;
                factDisplay.style.display = 'block';
            }
        }

        // Continue playing after reading fact
        function continuePlaying() {
            document.getElementById('dogFactDisplay').style.display = 'none';

            // Resume game if it was paused by fact
            if (parkGameData.factPaused) {
                parkGameData.paused = false;
                parkGameData.factPaused = false;
            }
        }

        // Set game speed
        function setGameSpeed(speed, button) {
            if (!parkGameData) {
                console.error('parkGameData is not defined!');
                return;
            }

            parkGameData.baseSpeed = speed;

            // Update display to show base speed (commented out - element doesn't exist)
            // document.getElementById('gameSpeed').textContent = speed + 'x';

            // If game is active, update current speed and restart spawning with new speed
            if (parkGameData.gameActive) {
                parkGameData.gameSpeed = speed;

                // Restart item spawning with new speed
                if (parkGameData.itemSpawnInterval) {
                    clearInterval(parkGameData.itemSpawnInterval);
                    startItemSpawning();
                }
            }

            // Show speed change notification
            const speedNames = {
                0.5: 'Slow',
                1: 'Normal',
                1.5: 'Fast'
            };

            // Update the speed label
            const speedLabel = document.getElementById('currentSpeedLabel');
            if (speedLabel) {
                speedLabel.textContent = `${speedNames[speed]} (${speed}x)`;
                speedLabel.style.color = speed === 0.5 ? '#17a2b8' : speed === 1 ? '#28a745' : '#dc3545';
            }

            showToast(`🎮 Speed changed to ${speedNames[speed]} (${speed}x)`);

            // Reset all speed buttons first
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('speed-selected');
                // Clear any inline styles except padding
                const padding = btn.style.padding;
                btn.removeAttribute('style');
                btn.style.padding = padding;
            });

            // Highlight selected speed button
            if (button) {
                button.classList.add('speed-selected');
            }
        }

        // Handle obstacle hit
        function handleObstacleHit(item) {
            parkGameData.lives--;

            // Visual feedback
            const dog = document.getElementById('dogCharacter');
            dog.style.color = 'red';
            setTimeout(() => dog.style.color = '', 500);

            // Show warning
            showToast(`⚠️ Hit a squirrel! ${parkGameData.lives} ${parkGameData.lives === 1 ? 'life' : 'lives'} left!`);

            // Update lives display
            updateLivesDisplay();

            // Clear item interval
            if (item.dataset.moveInterval) {
                clearInterval(parseInt(item.dataset.moveInterval));
            }
            item.remove();

            // Check for game over
            if (parkGameData.lives <= 0) {
                endParkGame(true); // true = lost due to obstacles
            }
        }

        // Update lives display
        function updateLivesDisplay() {
            const livesDisplay = document.getElementById('livesLeft');
            let hearts = '';
            for (let i = 0; i < parkGameData.lives; i++) {
                hearts += '❤️';
            }
            livesDisplay.textContent = hearts;
        }

        // Update display
        function updateParkDisplay() {
            document.getElementById('parkScore').textContent = parkGameData.score;
            document.getElementById('parkTimer').textContent = parkGameData.timeLeft;
            document.getElementById('bonesCollected').textContent = parkGameData.bonesCollected;
            updateLivesDisplay();
        }

        // End park game
        function endParkGame(lostToObstacle = false) {
            parkGameData.gameActive = false;
            clearInterval(parkGameData.timerInterval);
            clearInterval(parkGameData.itemSpawnInterval);

            // Clear remaining items
            document.querySelectorAll('.game-item').forEach(item => {
                if (item.dataset.moveInterval) {
                    clearInterval(parseInt(item.dataset.moveInterval));
                }
            });

            // Different messages for different endings
            if (lostToObstacle) {
                showToast(`💔 Game Over! Too many squirrels! Final Score: ${parkGameData.score}`);
            } else if (parkGameData.score > parkGameData.highScore) {
                parkGameData.highScore = parkGameData.score;
                localStorage.setItem('parkGameHighScore', parkGameData.highScore);
                document.getElementById('parkHighScore').textContent = parkGameData.highScore;
                showToast(`🎉 NEW HIGH SCORE: ${parkGameData.highScore}! 🎉`);
            } else {
                showToast(`⏰ Time's up! Score: ${parkGameData.score} | Bones: ${parkGameData.bonesCollected} 🦴`);
            }
        }

        // Close game
        function closeGame(gameId) {
            if (gameId === 'dogPark') {
                // Stop timers
                if (parkGameData.timerInterval) clearInterval(parkGameData.timerInterval);
                if (parkGameData.itemSpawnInterval) clearInterval(parkGameData.itemSpawnInterval);

                // Remove keyboard listener
                document.removeEventListener('keydown', handleKeyPress);

                document.getElementById('dogParkGame').style.display = 'none';

                // Hide overlay for dogPark
                const overlay = document.getElementById('gameOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            } else if (gameId === 'snowflake') {
                // Stop timers
                if (snowGameData.timerInterval) clearInterval(snowGameData.timerInterval);
                if (snowGameData.spawnInterval) clearInterval(snowGameData.spawnInterval);

                document.getElementById('snowflakeGame').style.display = 'none';

                // Hide overlay for snowflake
                const overlay = document.getElementById('gameOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            } else if (gameId === 'dragonMaze') {
                // Stop game
                mazeGameData.gameActive = false;

                // Remove keyboard listener
                document.removeEventListener('keydown', handleMazeKeyPress);

                document.getElementById('dragonMazeGame').style.display = 'none';
                // No overlay to hide for Dragon Maze
            } else if (gameId === 'slidingPuzzle') {
                document.getElementById('slidingPuzzleGame').style.display = 'none';
                puzzleGameData.gameActive = false;
            }
        }

        // Snowflake Game Functions
        function startSnowflakeGame() {
            const gameDiv = document.getElementById('snowflakeGame');
            gameDiv.style.display = 'block';

            // Load best combo on game start
            snowGameData.bestCombo = parseInt(localStorage.getItem('snowBestCombo') || '0');
            document.getElementById('snowBestCombo').textContent = snowGameData.bestCombo;

            // Create overlay
            let overlay = document.getElementById('gameOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'gameOverlay';
                overlay.className = 'game-overlay';
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'block';

            resetSnowGame();
            setupSnowflakeControls();
        }

        function setupSnowflakeControls() {
            const gameArea = document.getElementById('snowGameArea');
            const catcher = document.getElementById('snowCatcher');

            // Mouse move
            gameArea.addEventListener('mousemove', (e) => {
                if (!snowGameData.gameActive || snowGameData.paused) return;
                const rect = gameArea.getBoundingClientRect();
                snowGameData.catcherX = e.clientX - rect.left - 20;
                snowGameData.catcherY = e.clientY - rect.top - 20;
                catcher.style.left = snowGameData.catcherX + 'px';
                catcher.style.top = snowGameData.catcherY + 'px';
            });

            // Touch move
            gameArea.addEventListener('touchmove', (e) => {
                if (!snowGameData.gameActive || snowGameData.paused) return;
                e.preventDefault();
                const rect = gameArea.getBoundingClientRect();
                snowGameData.catcherX = e.touches[0].clientX - rect.left - 20;
                snowGameData.catcherY = e.touches[0].clientY - rect.top - 20;
                catcher.style.left = snowGameData.catcherX + 'px';
                catcher.style.top = snowGameData.catcherY + 'px';
            }, { passive: false });
        }

        function startSnowGame() {
            if (snowGameData.gameActive) return;
            snowGameData.gameActive = true;
            snowGameData.paused = false;

            // Start spawning snowflakes with speed adjustment
            snowGameData.spawnInterval = setInterval(() => {
                if (!snowGameData.paused && snowGameData.gameActive) {
                    spawnSnowflake();
                }
            }, 800 / snowGameData.gameSpeed);

            // Start timer
            snowGameData.timerInterval = setInterval(() => {
                if (!snowGameData.paused && snowGameData.gameActive) {
                    snowGameData.timeLeft--;
                    document.getElementById('snowTimer').textContent = snowGameData.timeLeft;
                    if (snowGameData.timeLeft <= 0) {
                        endSnowGame();
                    }
                }
            }, 1000);
        }

        function spawnSnowflake() {
            const gameArea = document.getElementById('snowGameArea');
            const snowflake = document.createElement('div');
            snowflake.className = 'falling-snowflake';

            // All snowflakes are the same now (no special ones)
            snowflake.innerHTML = '❄️';
            snowflake.style.color = '#87CEEB';

            // Set initial position and size
            snowflake.style.position = 'absolute';
            snowflake.style.left = Math.random() * (gameArea.offsetWidth - 30) + 'px';
            snowflake.style.top = '-50px';
            snowflake.style.fontSize = '30px';
            snowflake.style.zIndex = '10';

            gameArea.appendChild(snowflake);

            // Store reference
            snowGameData.snowflakes.push(snowflake);

            // Animate falling with collision detection
            const fallInterval = setInterval(() => {
                if (snowGameData.paused || !snowGameData.gameActive) return;
                if (snowflake.classList.contains('caught')) {
                    clearInterval(fallInterval);
                    return;
                }

                const currentTop = parseFloat(snowflake.style.top);
                const newTop = currentTop + (3 * snowGameData.gameSpeed);
                snowflake.style.top = newTop + 'px';

                // Check collision with glove
                checkSnowflakeCollision(snowflake);

                // Check if missed
                if (newTop > gameArea.offsetHeight) {
                    clearInterval(fallInterval);
                    if (!snowflake.classList.contains('caught')) {
                        handleMissedSnowflake();
                        snowflake.remove();
                        // Remove from array
                        const index = snowGameData.snowflakes.indexOf(snowflake);
                        if (index > -1) snowGameData.snowflakes.splice(index, 1);
                    }
                }
            }, 30);
        }

        function checkSnowflakeCollision(snowflake) {
            if (snowflake.classList.contains('caught')) return;

            const catcher = document.getElementById('snowCatcher');
            const catcherRect = catcher.getBoundingClientRect();
            const snowRect = snowflake.getBoundingClientRect();
            const gameAreaRect = document.getElementById('snowGameArea').getBoundingClientRect();

            // Check collision
            if (catcherRect.left < snowRect.right &&
                catcherRect.right > snowRect.left &&
                catcherRect.top < snowRect.bottom &&
                catcherRect.bottom > snowRect.top) {
                catchSnowflake(snowflake);
            }
        }

        function handleMissedSnowflake() {
            snowGameData.missedSnowflakes++;
            snowGameData.combo = 0;
            document.getElementById('snowCombo').textContent = snowGameData.combo;
            document.getElementById('missedDisplay').textContent = `Missed: ${snowGameData.missedSnowflakes}/${snowGameData.maxMissed}`;

            // Flash red warning
            const display = document.getElementById('missedDisplay');
            display.style.fontSize = '20px';
            setTimeout(() => display.style.fontSize = '14px', 200);

            if (snowGameData.missedSnowflakes >= snowGameData.maxMissed) {
                endSnowGame(false);
            }
        }

        function buildSnowmanPart() {
            snowGameData.snowmanParts++;
            const snowmanDisplay = document.getElementById('snowmanDisplay');

            // Build snowman progressively with proper stacking
            if (snowGameData.snowmanParts === 1) {
                // Base - large circle
                snowmanDisplay.innerHTML = '<div style="font-size: 45px; margin: 0;">⚪</div>';
                showToast(`🎉 Snowman base built! (10/40 snowflakes caught)`);
            } else if (snowGameData.snowmanParts === 2) {
                // Body - medium on top of large (less overlap)
                snowmanDisplay.innerHTML = '<div style="font-size: 35px; margin: -3px 0 0 0;">⚪</div><div style="font-size: 45px; margin: -3px 0 0 0;">⚪</div>';
                showToast(`🎉 Snowman body added! (20/40 snowflakes caught)`);
            } else if (snowGameData.snowmanParts === 3) {
                // Head - small on top of medium on top of large (less overlap)
                snowmanDisplay.innerHTML = '<div style="font-size: 25px; margin: -2px 0 0 0;">⚪</div><div style="font-size: 35px; margin: -3px 0 0 0;">⚪</div><div style="font-size: 45px; margin: -3px 0 0 0;">⚪</div>';
                showToast(`🎉 Snowman head added! (30/40 snowflakes caught)`);
            } else if (snowGameData.snowmanParts === 4) {
                // Complete snowman - fill the screen with celebration!
                const gameArea = document.getElementById('snowGameArea');

                // Create a full-screen snowman celebration
                const celebration = document.createElement('div');
                celebration.style.position = 'absolute';
                celebration.style.top = '50%';
                celebration.style.left = '50%';
                celebration.style.transform = 'translate(-50%, -50%)';
                celebration.style.fontSize = '200px';
                celebration.style.zIndex = '1000';
                celebration.style.animation = 'snowmanComplete 1s ease';
                celebration.innerHTML = '⛄';
                gameArea.appendChild(celebration);

                // Also update the corner display
                snowmanDisplay.style.fontSize = '80px';
                snowmanDisplay.innerHTML = '⛄';

                showToast('⛄ SNOWMAN COMPLETE! YOU WIN! (40/40 caught)');

                // Add some falling confetti snowflakes for celebration
                for (let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.innerHTML = '❄️';
                        confetti.style.position = 'absolute';
                        confetti.style.left = Math.random() * gameArea.offsetWidth + 'px';
                        confetti.style.top = '-50px';
                        confetti.style.fontSize = '30px';
                        confetti.style.animation = 'snowfall 3s linear';
                        confetti.style.zIndex = '999';
                        gameArea.appendChild(confetti);
                        setTimeout(() => confetti.remove(), 3000);
                    }, i * 100);
                }

                endSnowGame(true);
            }
        }

        function catchSnowflake(snowflake) {
            if (snowflake.classList.contains('caught')) return;
            snowflake.classList.add('caught');

            snowGameData.caught++;
            snowGameData.combo++;

            // Track max combo for this game
            if (snowGameData.combo > snowGameData.maxCombo) {
                snowGameData.maxCombo = snowGameData.combo;
                document.getElementById('snowMaxCombo').textContent = snowGameData.maxCombo;
            }

            // Track best combo ever
            if (snowGameData.combo > snowGameData.bestCombo) {
                snowGameData.bestCombo = snowGameData.combo;
                localStorage.setItem('snowBestCombo', snowGameData.bestCombo);
                document.getElementById('snowBestCombo').textContent = snowGameData.bestCombo;
            }

            // Update display
            document.getElementById('snowCaught').textContent = snowGameData.caught;
            document.getElementById('snowCombo').textContent = snowGameData.combo;

            // Check for snowman building (every 10 snowflakes)
            if (snowGameData.caught % 10 === 0) {
                buildSnowmanPart();
            }

            // Animate catch
            snowflake.style.opacity = '0';
            snowflake.style.transform = 'scale(1.5)';
            setTimeout(() => {
                snowflake.remove();
                // Remove from array
                const index = snowGameData.snowflakes.indexOf(snowflake);
                if (index > -1) snowGameData.snowflakes.splice(index, 1);
            }, 300);

            // Show combo popup
            if (snowGameData.combo >= 5 && snowGameData.combo % 5 === 0) {
                showComboPopup();
            }
        }

        function showComboPopup() {
            const gameArea = document.getElementById('snowGameArea');
            const popup = document.createElement('div');
            popup.style.position = 'absolute';
            popup.style.top = '50%';
            popup.style.left = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.style.fontSize = '2em';
            popup.style.fontWeight = 'bold';
            popup.style.color = '#28a745';
            popup.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
            popup.style.zIndex = '100';
            popup.textContent = `${snowGameData.combo} IN A ROW!`;
            gameArea.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);
        }

        function pauseSnowGame() {
            if (!snowGameData.gameActive) return;
            snowGameData.paused = !snowGameData.paused;
            document.getElementById('snowPauseBtn').textContent = snowGameData.paused ? '▶️ Resume' : '⏸️ Pause';
        }

        function resetSnowGame() {
            // Stop timers
            if (snowGameData.timerInterval) clearInterval(snowGameData.timerInterval);
            if (snowGameData.spawnInterval) clearInterval(snowGameData.spawnInterval);

            // Clear all snowflakes
            document.querySelectorAll('.falling-snowflake').forEach(s => s.remove());

            // Load and preserve best combo
            const preservedBestCombo = parseInt(localStorage.getItem('snowBestCombo') || '0');
            const preservedBaseSpeed = snowGameData.baseSpeed || 1;

            snowGameData = {
                caught: 0,
                timeLeft: 60,
                combo: 0,
                maxCombo: 0,
                bestCombo: preservedBestCombo,
                timerInterval: null,
                gameActive: false,
                paused: false,
                snowflakes: [],
                spawnInterval: null,
                catcherX: 200,
                catcherY: 200,
                snowmanParts: 0,
                missedSnowflakes: 0,
                maxMissed: 10,
                gameSpeed: preservedBaseSpeed,
                baseSpeed: preservedBaseSpeed
            };

            // Update display
            document.getElementById('snowCaught').textContent = 0;
            document.getElementById('snowTimer').textContent = 60;
            document.getElementById('snowCombo').textContent = 0;
            document.getElementById('snowMaxCombo').textContent = 0;
            document.getElementById('snowBestCombo').textContent = snowGameData.bestCombo;
            document.getElementById('missedDisplay').textContent = 'Missed: 0/10';
            document.getElementById('snowmanDisplay').innerHTML = '';

            // Position catcher
            const catcher = document.getElementById('snowCatcher');
            catcher.style.left = '200px';
            catcher.style.top = '200px';
        }

        function endSnowGame(won = false) {
            snowGameData.gameActive = false;
            clearInterval(snowGameData.timerInterval);
            clearInterval(snowGameData.spawnInterval);

            // Clear all falling snowflakes
            document.querySelectorAll('.falling-snowflake').forEach(s => s.remove());
            snowGameData.snowflakes = [];

            // Show appropriate message
            if (won) {
                showToast(`⛄ YOU WIN! Built a snowman! Best combo: ${snowGameData.maxCombo} in a row!`);
            } else if (snowGameData.missedSnowflakes >= snowGameData.maxMissed) {
                showToast(`❄️ Game Over! Too many missed! Best combo: ${snowGameData.maxCombo} in a row`);
            } else {
                showToast(`❄️ Time's up! Caught ${snowGameData.caught} snowflakes! Best combo: ${snowGameData.maxCombo}`);
            }

            // Check if new best combo record
            if (snowGameData.maxCombo > snowGameData.bestCombo) {
                setTimeout(() => showToast(`🎉 NEW BEST COMBO RECORD: ${snowGameData.maxCombo} IN A ROW! 🎉`), 1500);
            }
        }

        // Set snow game speed
        function setSnowSpeed(speed, button) {
            snowGameData.baseSpeed = speed;

            if (snowGameData.gameActive) {
                snowGameData.gameSpeed = speed;

                // Restart spawning with new speed
                if (snowGameData.spawnInterval) {
                    clearInterval(snowGameData.spawnInterval);
                    snowGameData.spawnInterval = setInterval(() => {
                        if (!snowGameData.paused && snowGameData.gameActive) {
                            spawnSnowflake();
                        }
                    }, 800 / snowGameData.gameSpeed);
                }
            }

            // Update display
            const speedNames = {
                0.5: 'Slow',
                1: 'Normal',
                1.5: 'Fast'
            };

            document.getElementById('currentSnowSpeed').textContent = `${speedNames[speed]} (${speed}x)`;

            // Update button styles
            document.querySelectorAll('.snow-speed-btn').forEach(btn => {
                btn.style.background = '';
                btn.style.fontWeight = '';
            });

            if (button) {
                button.style.background = '#28a745';
                button.style.fontWeight = 'bold';
            }

            showToast(`❄️ Speed: ${speedNames[speed]}`);
        }

        // Dragon Maze Game Functions
        function setMazeDifficulty(difficulty, button) {
            const settings = {
                easy: { size: 5, moves: 50 },
                medium: { size: 7, moves: 75 },
                hard: { size: 10, moves: 100 }
            };

            mazeGameData.difficulty = difficulty;
            mazeGameData.mazeSize = settings[difficulty].size;
            mazeGameData.maxMoves = settings[difficulty].moves;

            // Update UI
            document.getElementById('mazeMoveLimit').textContent = mazeGameData.maxMoves;
            document.getElementById('maxMoves').textContent = mazeGameData.maxMoves;

            // Update button styles
            document.querySelectorAll('.maze-difficulty-btn').forEach(btn => {
                btn.style.background = '#667eea';
            });
            if (button) {
                button.style.background = '#28a745';
            }

            // Reset and regenerate maze with new size
            if (mazeGameData.canvas) {
                mazeGameData.cellSize = Math.floor(mazeGameData.canvas.width / mazeGameData.mazeSize);
                startMazeGame();
            }

            showToast(`🐉 Difficulty: ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`);
        }

        function startDragonMazeGame() {
            const gameDiv = document.getElementById('dragonMazeGame');
            gameDiv.style.display = 'block';

            // Initialize canvas with delay to ensure proper rendering
            setTimeout(() => {
                mazeGameData.canvas = document.getElementById('mazeCanvas');
                mazeGameData.ctx = mazeGameData.canvas.getContext('2d');
                mazeGameData.cellSize = Math.floor(mazeGameData.canvas.width / mazeGameData.mazeSize);

                // Clear canvas first with white background
                mazeGameData.ctx.fillStyle = '#ffffff';
                mazeGameData.ctx.fillRect(0, 0, mazeGameData.canvas.width, mazeGameData.canvas.height);

                // Load best score for current difficulty
                const bestScoreKey = `mazeBestMoves_${mazeGameData.difficulty}`;
                mazeGameData.bestMoves = parseInt(localStorage.getItem(bestScoreKey) || '999');
                if (mazeGameData.bestMoves === 999) {
                    document.getElementById('mazeBestMoves').textContent = '--';
                } else {
                    document.getElementById('mazeBestMoves').textContent = mazeGameData.bestMoves;
                }

                startMazeGame();
            }, 50);
        }

        function generateMaze() {
            const size = mazeGameData.mazeSize;

            // Initialize all walls as existing (true = wall exists)
            mazeGameData.walls.horizontal = [];
            mazeGameData.walls.vertical = [];

            // Create grid of walls - horizontal walls are above each cell, vertical walls are to the left
            for (let y = 0; y <= size; y++) {
                mazeGameData.walls.horizontal[y] = new Array(size).fill(true);
            }
            for (let y = 0; y < size; y++) {
                mazeGameData.walls.vertical[y] = new Array(size + 1).fill(true);
            }

            // Track visited cells for maze generation
            const visited = [];
            for (let y = 0; y < size; y++) {
                visited[y] = new Array(size).fill(false);
            }

            // Recursive backtracking to generate maze
            function carvePassage(x, y) {
                visited[y][x] = true;

                // Create list of directions in random order
                const directions = [
                    { dx: 0, dy: -1, wall: 'top' },
                    { dx: 1, dy: 0, wall: 'right' },
                    { dx: 0, dy: 1, wall: 'bottom' },
                    { dx: -1, dy: 0, wall: 'left' }
                ].sort(() => Math.random() - 0.5);

                for (let { dx, dy, wall } of directions) {
                    const nx = x + dx;
                    const ny = y + dy;

                    // Check if neighbor is valid and unvisited
                    if (nx >= 0 && nx < size && ny >= 0 && ny < size && !visited[ny][nx]) {
                        // Remove wall between current cell and neighbor
                        switch (wall) {
                            case 'top':
                                mazeGameData.walls.horizontal[y][x] = false;
                                break;
                            case 'bottom':
                                mazeGameData.walls.horizontal[y + 1][x] = false;
                                break;
                            case 'left':
                                mazeGameData.walls.vertical[y][x] = false;
                                break;
                            case 'right':
                                mazeGameData.walls.vertical[y][x + 1] = false;
                                break;
                        }

                        // Continue carving from the neighbor
                        carvePassage(nx, ny);
                    }
                }
            }

            // Start carving from position (0,0)
            carvePassage(0, 0);

            // Set start (dragon) and end (princess) positions
            mazeGameData.dragon = { x: 0, y: 0 };
            mazeGameData.princess = { x: size - 1, y: size - 1 };

            // No obstacles - removed for better gameplay
            mazeGameData.obstacles = [];
        }

        function startMazeGame() {
            // Generate new maze
            generateMaze();

            // Reset game state
            mazeGameData.dragon = { x: 0, y: 0 };
            mazeGameData.princess = { x: mazeGameData.mazeSize - 1, y: mazeGameData.mazeSize - 1 };
            mazeGameData.moves = 0;
            mazeGameData.gameActive = true;
            mazeGameData.path = [{ x: 0, y: 0 }];

            // Update display
            document.getElementById('mazeMovesCount').textContent = '0';
            document.getElementById('mazeLevel').textContent = mazeGameData.level;

            // Draw maze
            drawMaze();

            // Set up keyboard controls
            document.addEventListener('keydown', handleMazeKeyPress);
        }

        function drawMaze() {
            const ctx = mazeGameData.ctx;
            const cellSize = mazeGameData.cellSize;
            const size = mazeGameData.mazeSize;

            // Clear canvas and set white background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, mazeGameData.canvas.width, mazeGameData.canvas.height);

            // Fill background for all cells
            for (let y = 0; y < size; y++) {
                for (let x = 0; x < size; x++) {
                    const xPos = x * cellSize;
                    const yPos = y * cellSize;

                    // Check if this cell has an obstacle
                    const hasObstacle = mazeGameData.obstacles.find(o => o.x === x && o.y === y);

                    if (hasObstacle) {
                        ctx.fillStyle = '#ffe0e0';
                    } else {
                        ctx.fillStyle = '#f8f8f8';
                    }
                    ctx.fillRect(xPos, yPos, cellSize, cellSize);

                    // Draw obstacles
                    if (hasObstacle) {
                        ctx.font = `${cellSize * 0.6}px Arial`;
                        ctx.fillText('🔥', xPos + cellSize * 0.2, yPos + cellSize * 0.7);
                    }
                }
            }

            // Draw walls
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 3;

            // Draw horizontal walls
            for (let y = 0; y <= size; y++) {
                for (let x = 0; x < size; x++) {
                    if (mazeGameData.walls.horizontal[y][x]) {
                        ctx.beginPath();
                        ctx.moveTo(x * cellSize, y * cellSize);
                        ctx.lineTo((x + 1) * cellSize, y * cellSize);
                        ctx.stroke();
                    }
                }
            }

            // Draw vertical walls
            for (let y = 0; y < size; y++) {
                for (let x = 0; x <= size; x++) {
                    if (mazeGameData.walls.vertical[y][x]) {
                        ctx.beginPath();
                        ctx.moveTo(x * cellSize, y * cellSize);
                        ctx.lineTo(x * cellSize, (y + 1) * cellSize);
                        ctx.stroke();
                    }
                }
            }

            // Draw path trail
            ctx.strokeStyle = 'rgba(102, 126, 234, 0.3)';
            ctx.lineWidth = cellSize / 4;
            ctx.lineCap = 'round';
            ctx.beginPath();
            for (let i = 0; i < mazeGameData.path.length; i++) {
                const p = mazeGameData.path[i];
                const xPos = p.x * cellSize + cellSize / 2;
                const yPos = p.y * cellSize + cellSize / 2;
                if (i === 0) {
                    ctx.moveTo(xPos, yPos);
                } else {
                    ctx.lineTo(xPos, yPos);
                }
            }
            ctx.stroke();

            // Draw princess
            const princessX = mazeGameData.princess.x * cellSize;
            const princessY = mazeGameData.princess.y * cellSize;
            ctx.font = `${cellSize * 0.7}px Arial`;
            ctx.fillText('👸', princessX + cellSize * 0.15, princessY + cellSize * 0.75);

            // Draw dragon
            const dragonX = mazeGameData.dragon.x * cellSize;
            const dragonY = mazeGameData.dragon.y * cellSize;
            ctx.font = `${cellSize * 0.8}px Arial`;
            ctx.fillText('🐉', dragonX + cellSize * 0.1, dragonY + cellSize * 0.8);
        }

        function moveDragon(direction) {
            if (!mazeGameData.gameActive) return;

            const dragon = mazeGameData.dragon;
            let canMove = false;

            // Check if movement is blocked by a wall
            switch (direction) {
                case 'up':
                    if (dragon.y > 0 && !mazeGameData.walls.horizontal[dragon.y][dragon.x]) {
                        canMove = true;
                        dragon.y--;
                    }
                    break;
                case 'down':
                    if (dragon.y < mazeGameData.mazeSize - 1 && !mazeGameData.walls.horizontal[dragon.y + 1][dragon.x]) {
                        canMove = true;
                        dragon.y++;
                    }
                    break;
                case 'left':
                    if (dragon.x > 0 && !mazeGameData.walls.vertical[dragon.y][dragon.x]) {
                        canMove = true;
                        dragon.x--;
                    }
                    break;
                case 'right':
                    if (dragon.x < mazeGameData.mazeSize - 1 && !mazeGameData.walls.vertical[dragon.y][dragon.x + 1]) {
                        canMove = true;
                        dragon.x++;
                    }
                    break;
            }

            if (!canMove) {
                // Hit wall - could add bump animation
                return;
            }

            // Check for obstacles
            const hasObstacle = mazeGameData.obstacles.find(o => o.x === dragon.x && o.y === dragon.y);
            if (hasObstacle) {
                showToast('🔥 Ouch! Fire blocks your path!');
                mazeGameData.moves += 2; // Penalty for hitting obstacle
                document.getElementById('mazeMovesCount').textContent = mazeGameData.moves;
                checkMazeLose();
                return;
            }

            // Valid move
            mazeGameData.moves++;
            mazeGameData.path.push({ x: dragon.x, y: dragon.y });

            // Update display
            document.getElementById('mazeMovesCount').textContent = mazeGameData.moves;

            // Check for win
            if (dragon.x === mazeGameData.princess.x && dragon.y === mazeGameData.princess.y) {
                winMaze();
                return;
            }

            // Check for lose
            checkMazeLose();

            // Redraw
            drawMaze();
        }

        function handleMazeKeyPress(e) {
            if (!mazeGameData.gameActive) return;

            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    moveDragon('up');
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    moveDragon('down');
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    moveDragon('left');
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    moveDragon('right');
                    break;
            }
        }

        function checkMazeLose() {
            if (mazeGameData.moves >= mazeGameData.maxMoves) {
                mazeGameData.gameActive = false;
                const overlay = document.getElementById('mazeOverlay');
                overlay.style.display = 'flex';
                overlay.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 48px;">😢</div>
                        <div>Too many moves!</div>
                        <div style="font-size: 16px; margin-top: 10px;">The princess is still waiting...</div>
                        <button class="game-btn" onclick="resetMaze()" style="margin-top: 15px;">Try Again</button>
                    </div>
                `;
                showToast('💔 Game Over! Too many moves!');
            }
        }

        function winMaze() {
            mazeGameData.gameActive = false;

            // Check for best score per difficulty
            const bestScoreKey = `mazeBestMoves_${mazeGameData.difficulty}`;
            if (mazeGameData.bestMoves === null || mazeGameData.bestMoves === 999 || mazeGameData.moves < mazeGameData.bestMoves) {
                mazeGameData.bestMoves = mazeGameData.moves;
                localStorage.setItem(bestScoreKey, mazeGameData.bestMoves);
                document.getElementById('mazeBestMoves').textContent = mazeGameData.bestMoves;
            }

            const overlay = document.getElementById('mazeOverlay');
            overlay.style.display = 'flex';
            overlay.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 48px;">🎉</div>
                    <div>Princess Rescued!</div>
                    <div style="font-size: 16px; margin-top: 10px;">Completed in ${mazeGameData.moves} moves!</div>
                    <button class="game-btn" onclick="nextMazeLevel()" style="margin-top: 15px;">Next Level</button>
                </div>
            `;

            showToast(`👸 Princess rescued in ${mazeGameData.moves} moves!`);
        }

        function resetMaze() {
            const overlay = document.getElementById('mazeOverlay');
            overlay.style.display = 'none';

            // Reset to start position
            mazeGameData.dragon = { x: 0, y: 0 };
            mazeGameData.moves = 0;
            mazeGameData.path = [{ x: 0, y: 0 }];
            mazeGameData.gameActive = true;

            document.getElementById('mazeMovesCount').textContent = '0';
            drawMaze();
        }

        function nextMazeLevel() {
            mazeGameData.level++;
            mazeGameData.maxMoves = Math.max(60, 100 - mazeGameData.level * 5); // Gets harder gradually
            document.getElementById('mazeMoveLimit').textContent = mazeGameData.maxMoves;
            document.getElementById('maxMoves').textContent = mazeGameData.maxMoves;

            const overlay = document.getElementById('mazeOverlay');
            overlay.style.display = 'none';

            startMazeGame();
        }

        function showMazeHint() {
            if (!mazeGameData.gameActive) return;

            // Penalty for using hint
            mazeGameData.moves += 5;
            document.getElementById('mazeMovesCount').textContent = mazeGameData.moves;

            // Show shortest path briefly
            // This would require implementing a pathfinding algorithm
            showToast('💡 Hint used! +5 moves penalty');

            checkMazeLose();
        }

        // Sliding Puzzle Game Functions
        function setPuzzleDifficulty(difficulty, button) {
            const settings = {
                easy: { size: 3 },
                medium: { size: 4 },
                hard: { size: 5 }
            };

            puzzleGameData.difficulty = difficulty;
            puzzleGameData.gridSize = settings[difficulty].size;

            // Update UI buttons
            const buttons = document.querySelectorAll('.puzzle-difficulty-btn');
            buttons.forEach(btn => {
                btn.style.background = '#667eea';
            });
            if (button) {
                button.style.background = '#28a745';
            }

            showToast(`🧩 Difficulty: ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`);
            startPuzzleGame();
        }

        function startSlidingPuzzleGame() {
            const gameDiv = document.getElementById('slidingPuzzleGame');
            gameDiv.style.display = 'block';

            // Load best score for current difficulty
            const bestScoreKey = `puzzleBestMoves_${puzzleGameData.difficulty}`;
            puzzleGameData.bestMoves = parseInt(localStorage.getItem(bestScoreKey) || '999');
            if (puzzleGameData.bestMoves === 999) {
                document.getElementById('puzzleBestMoves').textContent = '--';
            } else {
                document.getElementById('puzzleBestMoves').textContent = puzzleGameData.bestMoves;
            }

            startPuzzleGame();
        }

        function initializePuzzle(size) {
            const totalTiles = size * size;
            const tiles = [];
            for (let i = 1; i < totalTiles; i++) {
                tiles.push(i);
            }
            tiles.push(null); // Empty tile
            return tiles;
        }

        function shufflePuzzle() {
            const size = puzzleGameData.gridSize;
            const tiles = initializePuzzle(size);
            let emptyIndex = tiles.length - 1;

            // Perform valid moves to shuffle
            const moveCount = size === 3 ? 50 : size === 4 ? 80 : 120;
            for (let i = 0; i < moveCount; i++) {
                const validMoves = getValidPuzzleMoves(emptyIndex, size);
                if (validMoves.length > 0) {
                    const randomMove = validMoves[Math.floor(Math.random() * validMoves.length)];
                    [tiles[emptyIndex], tiles[randomMove]] = [tiles[randomMove], tiles[emptyIndex]];
                    emptyIndex = randomMove;
                }
            }

            puzzleGameData.tiles = tiles;
            puzzleGameData.moves = 0;
            puzzleGameData.isComplete = false;
            document.getElementById('puzzleMovesCount').textContent = '0';
            document.getElementById('puzzleComplete').style.display = 'none';
            renderPuzzle();
        }

        function getValidPuzzleMoves(emptyIndex, size) {
            const moves = [];
            const row = Math.floor(emptyIndex / size);
            const col = emptyIndex % size;

            if (row > 0) moves.push(emptyIndex - size); // Up
            if (row < size - 1) moves.push(emptyIndex + size); // Down
            if (col > 0) moves.push(emptyIndex - 1); // Left
            if (col < size - 1) moves.push(emptyIndex + 1); // Right

            return moves;
        }

        function startPuzzleGame() {
            shufflePuzzle();
            puzzleGameData.gameActive = true;
        }

        function renderPuzzle() {
            const grid = document.getElementById('puzzleGrid');
            const size = puzzleGameData.gridSize;
            const cellSize = Math.min(60, 280 / size);

            grid.style.gridTemplateColumns = `repeat(${size}, ${cellSize}px)`;
            grid.style.gridTemplateRows = `repeat(${size}, ${cellSize}px)`;
            grid.innerHTML = '';

            puzzleGameData.tiles.forEach((tile, index) => {
                const tileDiv = document.createElement('div');

                if (puzzleGameData.mode === 'picture' && tile) {
                    // Picture mode - show part of image
                    const correctRow = Math.floor((tile - 1) / size);
                    const correctCol = (tile - 1) % size;
                    const bgPosX = -(correctCol * cellSize);
                    const bgPosY = -(correctRow * cellSize);

                    tileDiv.style.cssText = `
                        width: ${cellSize}px;
                        height: ${cellSize}px;
                        background-image: url('${getPuzzleImage()}');
                        background-size: ${cellSize * size}px ${cellSize * size}px;
                        background-position: ${bgPosX}px ${bgPosY}px;
                        border: 0.5px solid rgba(255,255,255,0.3);
                        border-radius: 1px;
                        cursor: ${!puzzleGameData.isComplete ? 'pointer' : 'default'};
                        transition: all 0.3s;
                        position: relative;
                        overflow: hidden;
                    `;

                    // Add subtle number overlay for help
                    const numberOverlay = document.createElement('div');
                    numberOverlay.style.cssText = `
                        position: absolute;
                        top: 2px;
                        right: 2px;
                        background: rgba(0,0,0,0.5);
                        color: white;
                        padding: 2px 5px;
                        border-radius: 3px;
                        font-size: 12px;
                        font-weight: bold;
                    `;
                    numberOverlay.textContent = tile;
                    tileDiv.appendChild(numberOverlay);
                } else if (tile) {
                    // Numbers mode
                    tileDiv.style.cssText = `
                        width: ${cellSize}px;
                        height: ${cellSize}px;
                        background: ${getTileColor(tile)};
                        border: 1px solid rgba(255,255,255,0.5);
                        border-radius: 4px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: ${Math.max(16, cellSize/3)}px;
                        font-weight: bold;
                        color: white;
                        cursor: ${!puzzleGameData.isComplete ? 'pointer' : 'default'};
                        transition: all 0.3s;
                        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                    `;
                    tileDiv.textContent = tile;
                } else {
                    // Empty tile
                    tileDiv.style.cssText = `
                        width: ${cellSize}px;
                        height: ${cellSize}px;
                        background: transparent;
                        border: none;
                    `;
                }

                if (tile) {
                    tileDiv.onclick = () => handleTileClick(index);
                    tileDiv.onmouseover = () => {
                        if (!puzzleGameData.isComplete) {
                            tileDiv.style.transform = 'scale(1.05)';
                        }
                    };
                    tileDiv.onmouseout = () => {
                        tileDiv.style.transform = 'scale(1)';
                    };
                }

                grid.appendChild(tileDiv);
            });
        }

        function getTileColor(value) {
            const hue = (value * 25) % 360;
            return `hsl(${hue}, 70%, 60%)`;
        }

        function getPuzzleImage() {
            // Collection of kid-friendly images from Picsum (free image service)
            // These are curated IDs that show kid-appropriate content
            const imageIds = [
                '237', // Cute puppy
                '433', // Bear
                '1074', // Lion
                '582', // Fox
                '659', // Nature/forest
                '1084', // Walrus
                '783', // Monkey
                '1003', // Deer
                '593', // Tiger
                '837'  // Flowers
            ];

            // Use Picsum service for consistent, kid-friendly images
            // Size 300x300 for good quality
            const imageId = imageIds[puzzleGameData.currentImage % imageIds.length];
            return `https://picsum.photos/id/${imageId}/300/300`;
        }

        function togglePuzzleMode() {
            puzzleGameData.mode = puzzleGameData.mode === 'picture' ? 'numbers' : 'picture';
            document.getElementById('puzzleMode').textContent = puzzleGameData.mode === 'picture' ? 'Picture' : 'Numbers';
            renderPuzzle();
            showToast(`🧩 Mode: ${puzzleGameData.mode === 'picture' ? 'Picture 🎼️' : 'Numbers 1️⃣'}`);
        }

        function changePuzzleImage() {
            if (puzzleGameData.mode === 'picture') {
                puzzleGameData.currentImage = (puzzleGameData.currentImage + 1) % 10;
                renderPuzzle();
                showToast('🌄 Picture changed!');
            } else {
                showToast('Switch to Picture mode first!');
            }
        }

        function handleTileClick(index) {
            if (puzzleGameData.isComplete || !puzzleGameData.gameActive) return;

            const emptyIndex = puzzleGameData.tiles.indexOf(null);
            const validMoves = getValidPuzzleMoves(emptyIndex, puzzleGameData.gridSize);

            if (validMoves.includes(index)) {
                // Swap tiles
                [puzzleGameData.tiles[emptyIndex], puzzleGameData.tiles[index]] =
                [puzzleGameData.tiles[index], puzzleGameData.tiles[emptyIndex]];

                puzzleGameData.moves++;
                document.getElementById('puzzleMovesCount').textContent = puzzleGameData.moves;

                renderPuzzle();
                checkPuzzleCompletion();
            }
        }

        function checkPuzzleCompletion() {
            const tiles = puzzleGameData.tiles;
            const solved = tiles.every((tile, index) => {
                if (index === tiles.length - 1) return tile === null;
                return tile === index + 1;
            });

            if (solved) {
                puzzleGameData.isComplete = true;
                puzzleGameData.gameActive = false;

                // Update best score
                const bestScoreKey = `puzzleBestMoves_${puzzleGameData.difficulty}`;
                if (!puzzleGameData.bestMoves || puzzleGameData.moves < puzzleGameData.bestMoves) {
                    puzzleGameData.bestMoves = puzzleGameData.moves;
                    localStorage.setItem(bestScoreKey, puzzleGameData.moves.toString());
                    document.getElementById('puzzleBestMoves').textContent = puzzleGameData.bestMoves;
                }

                // Show completion message
                document.getElementById('puzzleFinalMoves').textContent = puzzleGameData.moves;
                document.getElementById('puzzleComplete').style.display = 'block';

                showToast(`🎉 Puzzle solved in ${puzzleGameData.moves} moves!`);
            }
        }

        // Make all functions globally accessible for onclick handlers IMMEDIATELY
        window.setGameSpeed = setGameSpeed;
        window.startParkGame = startParkGame;
        window.pauseParkGame = pauseParkGame;
        window.resetParkGame = resetParkGame;
        window.closeGame = closeGame;
        window.continuePlaying = continuePlaying;
        window.startSnowflakeGame = startSnowflakeGame;
        window.startSnowGame = startSnowGame;
        window.pauseSnowGame = pauseSnowGame;
        window.resetSnowGame = resetSnowGame;
        window.setSnowSpeed = setSnowSpeed;
        window.startDragonMazeGame = startDragonMazeGame;
        window.setMazeDifficulty = setMazeDifficulty;
        window.startSlidingPuzzleGame = startSlidingPuzzleGame;
        window.setPuzzleDifficulty = setPuzzleDifficulty;
        window.startPuzzleGame = startPuzzleGame;
        window.shufflePuzzle = shufflePuzzle;
        window.togglePuzzleMode = togglePuzzleMode;
        window.changePuzzleImage = changePuzzleImage;
        window.startMazeGame = startMazeGame;
        window.moveDragon = moveDragon;
        window.resetMaze = resetMaze;
        window.nextMazeLevel = nextMazeLevel;
        window.showMazeHint = showMazeHint;
        window.showPage = showPage;
        window.selectRating = selectRating;
        window.saveSettings = saveSettings;
        window.exportData = exportData;
        window.importData = importData;
        window.clearData = clearData;
        window.updateNow = updateNow;
        window.dismissUpdate = dismissUpdate;
        window.toggleCategory = toggleCategory;
        window.addSuggestedBook = addSuggestedBook;
        window.showLockedMessage = showLockedMessage;

        // Initialize app when page loads
        window.addEventListener('DOMContentLoaded', initApp);

        // Developer test mode - Press Ctrl+Shift+G to toggle test mode (G for Games)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'G') {
                e.preventDefault(); // Prevent any browser default action
                testMode = !testMode;
                if (testMode) {
                    showToast('🎮 Test Mode ENABLED - All games unlocked!');
                } else {
                    showToast('Test Mode disabled');
                }

                // Refresh games page if currently viewing it
                const gamesPage = document.getElementById('games');
                if (gamesPage && gamesPage.classList.contains('active')) {
                    displayGames();
                }
            }
        });

        // Mobile test mode activation - tap the Games tab title 5 times quickly
        let tapCount = 0;
        let tapTimer = null;

        // Listen for taps on the Games page title
        document.addEventListener('click', function(e) {
            // Check if clicking on Games tab content title or the Games nav button
            const isGamesTitle = e.target.tagName === 'H2' && e.target.textContent.includes('🎮 Games');
            const isGamesNavButton = e.target.classList.contains('nav-button') && e.target.textContent.includes('Games');

            if (isGamesTitle || isGamesNavButton) {
                tapCount++;

                // Clear previous timer
                if (tapTimer) clearTimeout(tapTimer);

                // Reset count after 2 seconds
                tapTimer = setTimeout(() => {
                    tapCount = 0;
                }, 2000);

                // Activate test mode after 5 taps
                if (tapCount >= 5) {
                    testMode = !testMode;
                    tapCount = 0;

                    if (testMode) {
                        showToast('🎮 Test Mode ENABLED - All games unlocked!');
                    } else {
                        showToast('Test Mode disabled');
                    }

                    // Refresh games page if currently viewing it
                    const gamesPage = document.getElementById('games');
                    if (gamesPage && gamesPage.classList.contains('active')) {
                        displayGames();
                    }
                }
            }
        });
    </script>
    <script src="js/bookSuggestions.js"></script>

    <!-- Install Prompt -->
    <div id="installPrompt" class="install-prompt">
        <div class="install-prompt-content">
            <h3>📚 Install 1000 Books App</h3>
            <p>Add to your home screen for easy access and offline use!</p>
            <div class="install-prompt-buttons">
                <button id="installBtn" class="install-btn install-btn-primary">Install</button>
                <button id="dismissBtn" class="install-btn install-btn-secondary">Not Now</button>
            </div>
        </div>
    </div>

    <script>
        // PWA Install Prompt
        let deferredPrompt = null;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const dismissBtn = document.getElementById('dismissBtn');
        const permanentInstallBtn = document.getElementById('permanentInstallBtn');

        // Check if app is already installed
        function isStandalone() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone ||
                   document.referrer.includes('android-app://');
        }

        // Show install button if not installed
        window.addEventListener('load', () => {
            if (!isStandalone() && permanentInstallBtn) {
                permanentInstallBtn.style.display = 'block';
            }
        });

        // Listen for the install prompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the default prompt
            e.preventDefault();
            // Store the event for later use
            deferredPrompt = e;

            // Show the permanent install button
            if (permanentInstallBtn && !isStandalone()) {
                permanentInstallBtn.style.display = 'block';
            }

            // Check if user has previously dismissed the prompt
            const promptDismissed = localStorage.getItem('installPromptDismissed');
            const dismissedTime = localStorage.getItem('installPromptDismissedTime');
            const daysSinceDismissed = dismissedTime ?
                (Date.now() - parseInt(dismissedTime)) / (1000 * 60 * 60 * 24) : 999;

            // Show prompt if not dismissed or if it's been more than 7 days
            if (!promptDismissed || daysSinceDismissed > 7) {
                setTimeout(() => {
                    installPrompt.classList.add('show');
                }, 2000); // Show after 2 seconds
            }
        });

        // Function to trigger install from permanent button
        function triggerInstall() {
            if (!deferredPrompt) {
                // For iOS, show instructions
                if (isIOS()) {
                    alert('To install on iOS:\n1. Tap the Share button (square with arrow)\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add"');
                } else {
                    alert('To install:\n1. Look for the install icon in your browser\'s address bar\n2. Or use the browser menu → "Install app"');
                }
                return;
            }

            // Show the browser's install prompt
            deferredPrompt.prompt();

            // Wait for user choice
            deferredPrompt.userChoice.then((result) => {
                console.log(`User choice: ${result.outcome}`);

                // Hide the button if installed
                if (result.outcome === 'accepted') {
                    permanentInstallBtn.style.display = 'none';
                    localStorage.removeItem('installPromptDismissed');
                    localStorage.removeItem('installPromptDismissedTime');
                }

                // Clear the deferred prompt
                deferredPrompt = null;
            });
        }

        // Make triggerInstall globally accessible
        window.triggerInstall = triggerInstall;

        // Handle install button click
        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) {
                console.log('Install prompt not available');
                return;
            }

            // Hide the prompt
            installPrompt.classList.remove('show');

            // Show the browser's install prompt
            deferredPrompt.prompt();

            // Wait for user choice
            const result = await deferredPrompt.userChoice;
            console.log(`User choice: ${result.outcome}`);

            // Clear the deferred prompt
            deferredPrompt = null;

            // Clear dismissal if user installed
            if (result.outcome === 'accepted') {
                localStorage.removeItem('installPromptDismissed');
                localStorage.removeItem('installPromptDismissedTime');
            }
        });

        // Handle dismiss button click
        dismissBtn.addEventListener('click', () => {
            installPrompt.classList.remove('show');
            localStorage.setItem('installPromptDismissed', 'true');
            localStorage.setItem('installPromptDismissedTime', Date.now().toString());
        });

        // Check if app was installed
        window.addEventListener('appinstalled', () => {
            console.log('App was installed');
            installPrompt.classList.remove('show');
            deferredPrompt = null;
        });

        // For iOS devices - show custom install instructions
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        // Show iOS install instructions if needed
        if (isIOS() && !isStandalone()) {
            // Show the permanent install button for iOS
            if (permanentInstallBtn) {
                permanentInstallBtn.style.display = 'block';
            }

            // Check if not dismissed recently
            const iosDismissed = localStorage.getItem('iosInstallDismissed');
            const iosDismissedTime = localStorage.getItem('iosInstallDismissedTime');
            const daysSinceDismissed = iosDismissedTime ?
                (Date.now() - parseInt(iosDismissedTime)) / (1000 * 60 * 60 * 24) : 999;

            if (!iosDismissed || daysSinceDismissed > 7) {
                setTimeout(() => {
                    // Update prompt content for iOS
                    document.querySelector('#installPrompt h3').textContent = '📚 Add to Home Screen';
                    document.querySelector('#installPrompt p').textContent =
                        'Tap the share button and select "Add to Home Screen"';
                    installBtn.style.display = 'none';
                    dismissBtn.textContent = 'OK, Got it';

                    // Update dismiss handler for iOS
                    dismissBtn.onclick = () => {
                        installPrompt.classList.remove('show');
                        localStorage.setItem('iosInstallDismissed', 'true');
                        localStorage.setItem('iosInstallDismissedTime', Date.now().toString());
                    };

                    installPrompt.classList.add('show');
                }, 3000);
            }
        }
    </script>
</body>
</html>